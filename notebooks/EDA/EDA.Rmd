---
title: "EDA"
author: "by A.G."
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    toc: yes
    number_sections: true
    df_print: paged
    code_folding: hide
    fig_width: 10
    fig_height: 6
    theme: cerulean
    highlight: kate
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=5, message = F, warning = F, cache = T)
library(tidyverse)
library(plotly)
library(ggpubr)
library(GGally)
```

# Exploratory Data Analysis

From Features I have selected all the strains tested for AMP resistance, repeat-related features have been calculated based on beta-lactamase genes only.

For the following analysis strains with intermediate resistance and not tested strains will be removed.

## Read in the data 

Every table comes from  `features`

```{r data}
features_amp <- read_csv("/home/andrei/Data/HeteroR/results/tables/features_amp.csv")

features_amp_strain <- read_csv("/home/andrei/Data/HeteroR/results/tables/features_amp_strain.csv")
```


## RG counts distribution

### In strains tested for AMP

```{r}
amp_n_genes <- features_amp %>% select(strain, record_id) %>% distinct() %>% group_by(strain) %>% summarise(N=n())

ggplot(amp_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("RG count")+
  ylab("number of strains")


```


```{r}
summary(amp_n_genes$N)
```

It's almost the same number of RGs as in the total data set, because this data set size is 380 strains and total data set size is 414 strains.

### In strains with beta-lactamases genes only

```{r}
betaL_n_genes <- features_amp %>% 
  filter(grepl("beta-lactamase", AMR.Gene.Family)) %>% 
  select(strain, record_id) %>% 
  distinct() %>% 
  group_by(strain) %>% 
  summarise(N=n())

ggplot(betaL_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("RG count")+
  ylab("number of strains")

```

```{r}
summary(betaL_n_genes$N)
```

Every strain has at least one beta-lactamase gene.

## Gene presence

This supposed to be the main predictor of HR

We should not count repeats around other genes than beta-lactamases

### Number of beta-lactamases in R and S

I remove intermediate resistance (just 2 observations) and not tested strains (several observations)

#### As boxplots

```{r}
# add resistance testing results
n_beta_lac <- left_join(betaL_n_genes, features_amp %>% select(strain, resistance) %>% distinct(), by="strain") %>% 
  filter(resistance != "I", !is.na(resistance))

ggplot(n_beta_lac, aes(resistance, N))+
  geom_violin(aes(fill=resistance), alpha=0.6, draw_quantiles = c(0.25, 0.5, 0.75))+
  geom_jitter(alpha=0.2, width=0.25, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  xlab("resistance")+
  ylab("number of beta-lactamase genes")+
  guides(fill="none")

# geom_boxplot(aes(fill=resistance))+
  
```

Susceptible strains have less beta-lactamase genes on average compared to resistance strains.

#### As a bar plot 

Because number of BL genes is count data.

```{r}
#feat_amp$resistance <- factor()

ggplot(features_amp_strain, aes(n.beta.lac))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of beta-lactamase genes")+
  ylab("number of strains")
```

More accurate conclusion from this plot: if number of beta-lactamases is greater than 3 then strain is most likely resistant. The chance a strain with more than 3 BL genes to be susceptible is 0.0143 (1.43%).

## Beta-lactamase heatmap

### BL types in each strain

```{r, fig.width=20, fig.height=6}
# get unique AMR types
amr_types <- unique(features_amp$AMR.Gene.Family)

# get unique gene rows with AMR.Gene.Family
amp_amr_gene_types <- features_amp %>% select(strain, record_id, AMR.Gene.Family) %>% distinct()

# make a DF of each AMR type counts in each gene
amp_ampr_gene_presence <- as_tibble(
  as.data.frame(
    map(amr_types, function(x) ifelse(grepl(x, amp_amr_gene_types$AMR.Gene.Family, fixed = T), 1, 0)),
    col.names = amr_types))

# add strain and summarize counts
amp_ampr_gene_presence$strain <- amp_amr_gene_types$strain
amp_ampr_gene_presence <- relocate(amp_ampr_gene_presence, strain, .before="ampC.type.beta.lactamase")
# here sum is applied to all variables
amp_amr_types_strain <- amp_ampr_gene_presence %>% group_by(strain) %>% summarise_each(~sum(.))
# we need shorter names
names(amp_amr_types_strain) <- c("strain", "ampC", "DFR", "APH6", "APH3.1", "SUL", "TEM", "SAT", "ANT3", "MPH", "APH3.2", "CTX.M", "CAT", "AAC3", "OXA", "AAC6", "ANT2", "FTT", "SHV", "TR.RPP", "APH4", "QNR")

# make tidy for ggplot
amp_amr_types_strain_td <- gather(amp_amr_types_strain, key="AMR.type", value="N", 2:22)

# make a plot
ggplot(amp_amr_types_strain_td, aes(strain, AMR.type))+geom_tile(aes(fill=N))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, hjust=1, size = 4))+
  xlab("")+
  scale_fill_gradient2(high="blue")
```

### BL types per gene

???

```{r, fig.width=30, fig.height=6}
# add record_id
amp_ampr_gene_presence$record_id <- amp_amr_gene_types$record_id
amp_ampr_gene_presence <- relocate(amp_ampr_gene_presence, record_id, .before="ampC.type.beta.lactamase")

# names
names(amp_ampr_gene_presence) <- c("strain", "record_id" , "ampC", "DFR", "APH6", "APH3.1", "SUL", "TEM", "SAT", "ANT3", "MPH", "APH3.2", "CTX.M", "CAT", "AAC3", "OXA", "AAC6", "ANT2", "FTT", "SHV", "TR.RPP", "APH4", "QNR")

# make it tidy
amp_ampr_gene_presence_td <- gather(amp_ampr_gene_presence, key="AMR.type", value="N", 3:23)
amp_ampr_gene_presence_td$N <- factor(amp_ampr_gene_presence_td$N, ordered=T, levels=c(0,1))

# make a plot
ggplot(amp_ampr_gene_presence_td, aes(record_id, AMR.type))+geom_tile(aes(fill=N))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, hjust=1, size = 0.1))+
  xlab("")+
  scale_fill_discrete(type=c("white", "steelblue"))
  
```


## Number of plasmids

Per strain, doesn't depend on beta-lactamase presence or absence

### As a box plot

```{r}
ggplot(features_amp_strain, aes(resistance, n_plasmids))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("Number of plasmids")+
  ylab("N")+
  guides(fill="none")

```

### As a bar plot

```{r}
ggplot(features_amp_strain, aes(n_plasmids))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of plasmids")+
  ylab("number of strains")
```

## Repeat length

Distribution of repeat length around beta-lactamase genes in strains tested for AMP resistance

### All repeats

some zeros will be removed for plotting purposes only

```{r, fig.height=6, fig.width=14}

# all repeat length plot

###########################################
plot.mrl.all <- ggplot(features_amp_strain, aes(resistance, med.rep.len)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length, bp") +
  ggtitle(label="Median repeat length", subtitle = "All repeats")+
  guides(fill="none")

######################################

plot.mrl.cen <- ggplot(features_amp_strain %>% filter(med.rep.len.cen > 0), aes(resistance, med.rep.len.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth=T)+
  geom_jitter(alpha=0.1, width=0.15, height = 0.1, aes(color=resistance))+
  coord_trans(y="log")+
  scale_fill_brewer(palette = "Set1") +
  scale_color_brewer(palette = "Set1")+
  xlab("")+ ylab("length, bp")+
  ggtitle("", subtitle = "repeats spanning center")+
  guides(fill="none")

#####################################

plot.mrl.non.cen <- ggplot(features_amp_strain, aes(resistance, med.rep.len.non.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ ylab("length, bp")+
  ggtitle("", subtitle = "repeats not spanning center")+
  guides(fill="none")



##########################################
ggarrange(plot.mrl.all, plot.mrl.cen, plot.mrl.non.cen,
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

### Repeats longer than 100 bp


```{r, fig.height=6, fig.width=14}

#######################################

plot.mrl.all.100 <- ggplot(features_amp_strain, aes(resistance, med.rep.len.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle(label="Median repeat length", subtitle = "min 100 bp")+
  guides(fill="none")

#######################################

plot.mrl.cen.100 <- ggplot(features_amp_strain, aes(resistance, med.rep.len.cen.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth=T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ ylab("length")+
  ggtitle("Median repeat length", subtitle = "repeats spanning center, min 100 bp")+
  guides(fill="none")

###########################################

plot.mrl.non.cen.100 <- ggplot(features_amp_strain, aes(resistance, med.rep.len.non.cen.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ ylab("length")+
  ggtitle("Median repeat length", subtitle = "repeats not spanning center, min 100 bp")+
  guides(fill="none")


ggarrange(plot.mrl.all.100, plot.mrl.cen.100, plot.mrl.non.cen.100,
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

## Total repeat length

total repeat length in each gene divided by number of genes

total repeat length = sum of all repeats on one side of a gene from center-spanning repeat pairs


```{r}
plot.trl.all <- ggplot(features_amp_strain, aes(resistance, med.tot.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle("Total repeat length")+
  guides(fill="none")

plot.trl.all
```

## Maximum repeat length

some zeros are removed for plotting purposes

```{r, fig.width=14, fig.height=6}
plot.maxrl.all <- ggplot(features_amp_strain, aes(resistance, max.rep.len)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle("Maximum repeat length")

plot.maxrl.cen <- ggplot(features_amp_strain %>% filter(max.rep.len.cen > 0), aes(resistance, max.rep.len.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle("Maximum repeat length", subtitle = "repeats spanning gene's center")

plot.maxrl.non.cen <- ggplot(features_amp_strain, aes(resistance, max.rep.len.non.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle("Maximum repeat length", subtitle = "repeats not spanning gene's center")

ggarrange(plot.maxrl.all, plot.maxrl.cen, plot.maxrl.non.cen,
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```


## Repeat counts

### Per strain

```{r, fig.height=6, fig.width=14}
plot.rc.all <- ggplot(features_amp_strain, aes(resistance, n.rep.total)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("N") +
  ggtitle("Total repeat count")


plot.rc.cen <- ggplot(features_amp_strain, aes(resistance, n.rep.tot.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="Total repeat count", subtitle = "Repeats spanning region's center")

plot.rc.non.cen <- ggplot(features_amp_strain, aes(resistance, n.rep.tot.non.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="Total repeat count", subtitle = "Repeats not spanning region's center")


ggarrange(plot.rc.all, plot.rc.cen, plot.rc.non.cen, 
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

## Median amplifiable region size

### All repeats

```{r, fig.height=6, fig.width=14}

plot.arl.all <- ggplot(features_amp_strain, aes(resistance, med.AR.len)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size", subtitle = "All repeats")

plot.arl.cen <- ggplot(features_amp_strain, aes(resistance, med.AR.len.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size", subtitle = "Repeats spanning region's center")

plot.arl.non.cen <- ggplot(features_amp_strain, aes(resistance, med.AR.len.non.cen)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size", subtitle = "Repeats not spanning region's center")


ggarrange(plot.arl.all, plot.arl.cen, plot.arl.non.cen, 
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

### Repeats longer than 100 bp

Some zeros will be removed for plotting purposes only

```{r, fig.height=6, fig.width=14}
plot.arl.100 <- ggplot(features_amp_strain %>% filter(med.AR.len.100 > 0), aes(resistance, med.AR.len.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size, min repeat length 100 bp", subtitle = "All repeats")

plot.arl.cen.100 <- ggplot(features_amp_strain %>% filter(med.AR.len.cen.100 > 0), aes(resistance, med.AR.len.cen.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size, min repeat length 100 bp", subtitle = "Repeats spanning region's center")

plot.arl.non.cen.100 <- ggplot(features_amp_strain %>% filter(med.AR.len.non.cen.100 > 0), aes(resistance, med.AR.len.non.cen.100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle(label="AR size, min repeat length 100 bp", subtitle = "Repeats not spanning region's center")


ggarrange(plot.arl.100, plot.arl.cen.100, plot.arl.non.cen.100, 
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

## ampC genes

Statistics regarding only AmpC genes

### Total repeat count

#### As a box plot

```{r}
ggplot(features_amp_strain, aes(resistance, ampC.n.rep.tot))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC: repeat count")+
  ylab("N")+
  guides(fill="none")
  
```

#### As a bar plot

```{r}
ggplot(features_amp_strain, aes(ampC.n.rep.tot))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of repeats")+
  ylab("number of strains")
```

### Median repeat length

```{r}
ggplot(features_amp_strain, aes(resistance, ampC.med.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC: median repeat length")+
  ylab("length")+
  guides(fill="none")
```

### Max repeat length

```{r}
ggplot(features_amp_strain, aes(resistance, ampC.max.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC: max repeat length")+
  ylab("length")+
  guides(fill="none")
```


### Median sum of repeat lengths

```{r, warning=F}
ggplot(features_amp_strain, aes(resistance, ampC.med.tot.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC: median sum of repeat lengths")+
  ylab("length")+
  guides(fill="none")
```


### Median AR size

```{r, fig.width=14}
plot.ampc.med.AR <- ggplot(features_amp_strain, aes(resistance, ampC.med.AR.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC: median AR size")+
  ylab("AR size")+
  guides(fill="none")

plot.ampc.med.AR.cen <- ggplot(features_amp_strain, aes(resistance, ampC.med.AR.len.cen))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC: median AR size spanning gene center")+
  ylab("")+
  guides(fill="none")

ggarrange(plot.ampc.med.AR, plot.ampc.med.AR.cen, ncol=2, nrow=1, legend = "bottom")

```


## Pairs plot

```{r}
names(features_amp_strain)
```


```{r, fig.width=15, fig.height=10, warning=F, message=F}
# use GGally

ggpairs(features_amp_strain, 
        columns=c(4,5,6,7,9,10,15,16,22,23,25,27,28), 
        aes(color=resistance, alpha=0.2, dotsize=0.02), 
        upper = list(continuous = wrap("cor", size = 2.5)),
        diag=list(continuous ="barDiag"))+
  scale_color_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")
```


## Per gene statistics

Not clear how to interpret and embed in per-strain prediction.

Around beta-lactamase genes only.

### All repeat lengths

Should `distinct()` be used?

```{r, fig.height=6, fig.width=14}
plot.rl.g.all <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac) %>% 
                            select(record_id, repeat_length, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, repeat_length)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.02, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("resistance")+ylab("N") +
  ggtitle("Repeat lengths")+
  guides(fill="none")


plot.rl.g.cen <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac, spans_center=="yes") %>% 
                            select(record_id, repeat_length, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, repeat_length)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.02, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("resistance")+ylab("N") +
  ggtitle("Repeat lengths", subtitle = "repeats spanning gene's center")+
  guides(fill="none")

plot.rl.g.non.cen <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac, spans_center=="no") %>% 
                            select(record_id, repeat_length, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, repeat_length)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.02, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("resistance")+ylab("N") +
  ggtitle("Repeat lengths", subtitle = "repeats not spanning gene's center")+
  guides(fill="none")

ggarrange(plot.rl.g.all, plot.rl.g.cen, plot.rl.g.non.cen, 
          ncol=3, nrow=1, 
          common.legend = T, legend = "bottom")
```

### Repeats longer than 100 bp

Under construction

### All repeat counts

Should `distinct()` be used?

```{r, fig.height=6, fig.width=14}
plot.rc.g.all.amp <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac) %>% 
                            select(record_id, n_repeats_gene, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, n_repeats_gene)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("N") +
  ggtitle("Repeat count per gene")


plot.rc.g.100.amp <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac, n_repeats_gene_min100 > 0) %>% 
                            select(record_id, n_repeats_gene_min100, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, n_repeats_gene_min100)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("")+
  ggtitle("Repeat count per gene, min 100 bp")


plot.rc.g.500.amp <- ggplot(features_amp %>% 
                            filter(!is.na(resistance), resistance != "I", is_beta_lac, n_repeats_gene_min500 > 0) %>% 
                            select(strain, n_repeats_gene_min500, AB, resistance) %>% 
                            distinct(), 
                          aes(resistance, n_repeats_gene_min500)) + 
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y="sqrt") +
  xlab("")+ylab("N")+
  ggtitle("Repeat count per gene, min 500 bp")

# plot.rc.g.1000.amp <- ggplot(features_amp %>% 
#                             select(strain, n_repeats_gene_min1000, AB, resistance) %>% 
#                             filter(!is.na(resistance), resistance != "I") %>% 
#                             distinct(), 
#                           aes(AB, n_repeats_gene_min1000)) + 
#   geom_violin(aes(fill=resistance), alpha=0.7)+
#   geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
#   coord_trans(y="sqrt") +
#   scale_fill_brewer(palette = "Set2") +
#   xlab("")+ylab("")+
#   ggtitle("Repeat count per gene, min 1000 bp")

ggarrange(plot.rc.g.all.amp, plot.rc.g.100.amp, plot.rc.g.500.amp,
          ncol=3, nrow=1,
          common.legend = T, legend = "bottom")
#plot.rc.g.100.amp
```

### Repeats longer than 100 bp

Under construction


# Plotting features for all AB

eval=FALSE

## Number of plasmids

### From summaries

```{r, eval=FALSE}
ggplot(features_filtered %>% 
         filter(!is.na(resistance)) %>% 
         filter(resistance !="I"), aes(AB, n_plasmids)) + 
  geom_boxplot(aes(fill=resistance), notch=T, outlier.alpha = 0.5, outlier.size = 0.5) +
  scale_fill_brewer(palette = "Set2") +
  coord_trans(y="sqrt") +
  xlab("")+
  ylab("n") +
  ggtitle("Plasmids count")
```

### From headers

Here plasmid numbers are calculated using relative depth of coverage
taken from assembly's fasta headers

```{r, fig.width=10, fig.height=4, eval=FALSE}
ggplot(features_filtered %>% 
         filter(!is.na(resistance)) %>% 
         filter(resistance !="I"), aes(AB, n_plasmids_alt)) + 
  geom_boxplot(aes(fill=resistance), notch=T, outlier.alpha = 0.5, outlier.size = 0.5) +
  scale_fill_brewer(palette = "Set2") +
  coord_trans(y="sqrt") +
  xlab("")+
  ylab("n") +
  ggtitle("Plasmids count (alternative count)")
```

## Repeat count

We already know that repeats shorter than 100 mainly make noise

### Repeats longer than 100 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, n_repeats_strain_min100, spans_center) %>% 
                   distinct()

ggbox.rc.ab.100 <- ggplot(feat_selected, aes(AB, n_repeats_strain_min100)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        coord_trans(y="sqrt") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat count", subtitle="Repeats > 100 bp")+
        xlab("")+
        ylab("")


ggbox.rc.ab.100
```

### Repeats longer than 500 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, n_repeats_strain_min500, spans_center) %>% 
                   distinct()


ggbox.rc.ab.500 <- ggplot(feat_selected, aes(AB, n_repeats_strain_min500)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        facet_grid(spans_center ~ .) +
        coord_trans(y="sqrt") +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat count", subtitle="Repeats > 500 bp")+
        xlab("")+
        ylab("")


ggbox.rc.ab.500
```

### Repeats longer than 1000 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, n_repeats_strain_min1000, spans_center) %>% 
                   distinct()


ggbox.rc.ab.1000 <- ggplot(feat_selected, aes(AB, n_repeats_strain_min1000)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        facet_grid(spans_center ~ .) +
        coord_trans(y="sqrt") +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat count", subtitle="Repeats > 1000 bp")+
        xlab("")+
        ylab("")


ggbox.rc.ab.1000
```

## Repeat length

### Repeats longer than 100 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 100) %>% 
                   distinct()

ggbox.rl.ab.100 <- ggplot(feat_selected, aes(AB, repeat_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        coord_trans(y="sqrt") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat length", subtitle="Repeats > 100 bp")+
        xlab("")+
        ylab("")


ggbox.rl.ab.100
```

### Repeats longer than 500 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 500) %>% 
                   distinct()

ggbox.rl.ab.500 <- ggplot(feat_selected, aes(AB, repeat_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        coord_trans(y="log") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat length", subtitle="Repeats > 500 bp")+
        xlab("")+
        ylab("")


ggbox.rl.ab.500
```

### Repeats longer than 1000 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 1000) %>% 
                   distinct()

ggbox.rl.ab.1000 <- ggplot(feat_selected, aes(AB, repeat_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        coord_trans(y="log") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat length", subtitle="Repeats > 1000 bp")+
        xlab("")+
        ylab("")


ggbox.rl.ab.1000
```

### Total repeat length

```{r, eval=FALSE}
ggplot(features_filtered %>%
         select(record_id, AB, resistance, total_repeat_length) %>%
         filter(resistance!="I") %>%
         distinct(), aes(AB, total_repeat_length))+
  geom_boxplot(aes(fill=resistance))+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set2")
```

## Amplifiable region size

### For repeats longer than 100 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, AR_length, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 100) %>% 
                   distinct()

ggbox.arl.ab.100 <- ggplot(feat_selected, aes(AB, AR_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Amplifiable region size", subtitle="Repeats > 100 bp")+
        xlab("")+
        ylab("")


ggbox.arl.ab.100

```

### For repeats longer than 500 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, AR_length, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 500) %>% 
                   distinct()

ggbox.arl.ab.500 <- ggplot(feat_selected, aes(AB, AR_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Amplifiable region size", subtitle="Repeats > 500 bp")+
        xlab("")+
        ylab("")


ggbox.arl.ab.500

```

### For repeats longer than 1000 bp

```{r, fig.width=10, fig.height=5, eval=FALSE}
# prepare df
feat_selected <- features_filtered %>%
                   filter(!is.na(resistance)) %>%
                   filter(resistance != "I") %>% 
                   select(strain, AB, resistance, AR_length, repeat_length, spans_center) %>% 
                   filter(repeat_length >= 1000) %>% 
                   distinct()

ggbox.arl.ab.1000 <- ggplot(feat_selected, aes(AB, AR_length)) +
        geom_boxplot(aes(fill = resistance), notch=F, outlier.alpha = 0.5, outlier.size = 0.5) +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Amplifiable region size", subtitle="Repeats > 1000 bp")+
        xlab("")+
        ylab("")

ggbox.arl.ab.1000

```

------------------------------------------------------------------------

# Save the workspace

```{r, eval=TRUE}
save.image(f="/home/andrei/Data/HeteroR/notebooks/EDA.RData")
```
