---
title: "Exploratory Data Analysis of Pip/Tazo HR strains"
author: "by A.G."
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    toc: yes
    number_sections: true
    df_print: paged
    code_folding: hide
    fig_width: 10
    fig_height: 6
    theme: cerulean
    highlight: kate
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = F, warning = F, cache = T)
library(tidyverse)
library(ggpubr)
library(factoextra)
library(cluster)
```

# Intro

Here I explore strains tested as HR and non-HR according to the most recent update from Karin.

AB is Piperacillin/Tazobactam

---

# Read the data

Data set `data_strain` has been made earlier in `feature_engineering.Rmd`

Look at target class distribution in full data set (500 strains)

```{r, cache=F}
data <- read_csv("/home/andrei/Data/HeteroR/results/tables/features_bl.csv")

data_strain <- read_csv("data/features_bl_strain.csv", na = c("NA", "-Inf"))

hr_testing <- read_csv("data/heteroresistance_testing.csv")

hr_testing %>% group_by(resistance) %>% summarize(N=n())
```

Quite imbalanced target class

Look at target class distribution in the data set you're working with (414 strains)

```{r}
data_strain %>% group_by(resistance) %>% summarize(N = n())
```

Well, 120 strains out of 500 tested are not assembled yet and, out of 414 assembled strains, 47 are not tested...

:(

## Some processing

1. Add BL genes counts as ordered factor and as binary features (if BL > 3)

2. Filter/Rename HR labels

It seems reasonable to merge R and HR group, because of two reasons:

 - We have too little R

 - It is useful to predict whether a strains *is* (R) or *turns* (HR) resistant, because both outcomes require similar actions from a clinician.
 
On the other hand, it has perfect sense to remove R strains completely: if our task is to distinguish susceptible strains and heteroresistant ones.


Here, I will remove R-strains.


```{r}
# BL counted as binary > 3
data_strain$n.beta.lac.3 <- ifelse(data_strain$n.beta.lac > 3, 1, 0)

data_strain$n.beta.lac.4 <- ifelse(data_strain$n.beta.lac > 4, 1, 0)

data_strain <- data_strain %>% 
  relocate(n.beta.lac.3, n.beta.lac.4, .before = "n.beta.lac") %>% 
  filter(resistance != "R") 

# resistance as factor
data_strain$resistance <- as.factor(data_strain$resistance)

# remove strain
# but keep them elsewhere
strains <- data_strain$strain
data_strain <- data_strain %>% select(-strain)

data_strain
```

# Descriptive stats

```{r}
skimr::skim(data_strain)
```

All missing data should be replaced with zeros.

# Remove non-informative columns

```{r}
sum_cols <- apply(data_strain[, -1], 2, function(x){sum(x, na.rm = T)})
sum_cols[sum_cols == 0]
```


Some columns contain only 0, I will remove them

```{r}
data_strain <- data_strain %>% 
  select(-c(DHA.beta.lactamase, APH.4.))
```


# Data imputation

`caret::preProcess()` doesn't have method for replacing with zeros...

```{r, cache=F}

data_strain[is.na(data_strain)] <- 0

```

# Write data for shiny app

```{r, eval=FALSE}
features_bl_shiny <- data_strain %>% 
  mutate("strain" = strains) %>% 
  relocate(strain, .before = resistance)

write.csv(features_bl_shiny, "shiny/data/features_ptz_strain.csv", row.names = F)
```


# Data scaling

scale and center numeric features (real numeric + count, not dummies!)

```{r, eval=F}
end <- length(data_strain)
# except for resistance and n.beta.lac.3 and n.beta.lac.4
data_strain_scaled <- as_tibble(
  scale(
    x = data_strain %>% select(-c(resistance, n.beta.lac.3, n.beta.lac.4)),
    center = T, scale = T
    ))

data_strain_scaled$resistance <- data_strain$resistance
data_strain_scaled$n.beta.lac.3 <- data_strain$n.beta.lac.3
data_strain_scaled$n.beta.lac.4 <- data_strain$n.beta.lac.4

data_strain_scaled <- data_strain_scaled %>% 
  relocate(n.beta.lac.3, n.beta.lac.4, .before = "n.beta.lac")

data_strain_scaled <- data_strain_scaled %>% 
  relocate(resistance, .before = "n.plasmids")

# write it for modelling
write.csv(data_strain_scaled, "../../modelling/PTZ_HR/data/features_ptz_hr_scaled.csv", row.names = F)
```


---


# Clustering

Let's do some clustering analysis on predictors.

Predictors should be standardized and imputed (they are).

## Dissimilarities heat map

Distance measure: Kendall's correlation

```{r, fig.width=10, fig.height=8}
feat_clust <- data_strain_scaled %>% select(-resistance)
row.names(feat_clust) <- strains
#feat_clust <- data_strain %>% select(-resistance)

distance <- get_dist(feat_clust, stand = F, method = "kendall")
fviz_dist(distance, gradient = list(low = "#bbab00", high = "#0000bb"), show_labels = T, lab_size = 6)
```

The darker is the color, the higher is dissimilarity

## k-means clustering

k = 2

```{r, fig.width=8, fig.height=6}
cent <- 2
km <- kmeans(feat_clust, centers = cent, nstart = 100)
fviz_cluster(km, data = feat_clust, repel = T, show.clust.cent = F, labelsize = 6)
```

### Correspondence between clusters and resistance

```{r}
feat_clust %>%
  mutate(cluster = km$cluster, resistance = data_strain$resistance) %>%
  select(resistance, cluster) %>% 
  table()
```


### Silhouette method

```{r, fig.width=6, fig.height=4}
fviz_nbclust(feat_clust, kmeans, method = "silhouette", diss = distance)
```

### Gap statistic

Suggests more clusters

```{r, fig.width=6, fig.height=4}
set.seed(123)
gap_stat <- clusGap(feat_clust, FUN = kmeans, nstart = 25,
                    K.max = 25, B = 50)

fviz_gap_stat(gap_stat)
```

???

# EDA

## Correlation plot

```{r, fig.width=12, fig.height=12}
# without resistance
cor_matrix <- cor(data_strain[,c(2:end)], use = "pairwise.complete.obs")
corrplot::corrplot(cor_matrix, type="upper", tl.col = "black")
```


## RG counts distribution

### In strains tested for AMP

```{r}
rg_n_genes <- data %>% select(strain, record_id) %>% distinct() %>% group_by(strain) %>% summarise(N=n())

ggplot(rg_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("RG count")+
  ylab("Strains count")


```


```{r}
summary(rg_n_genes$N)
```

Same number as in the total data set.

### In strains with beta-lactamases genes only

```{r}
betaL_n_genes <- data %>% 
  filter(grepl("beta-lactamase", AMR.Gene.Family)) %>% 
  select(strain, record_id) %>% 
  distinct() %>% 
  group_by(strain) %>% 
  summarise(N=n())

ggplot(betaL_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("BL count")+
  ylab("Strains count")

```

```{r}
summary(betaL_n_genes$N)
```

Every strain has at least one beta-lactamase gene.

## Gene presence

This supposed to be the main predictor of HR

### Number of beta-lactamases

#### Bar plot 

because number of BL genes is count data.

```{r}
#data_strain$resistance <- factor()

ggplot(data_strain, aes(n.beta.lac)) +
  geom_bar(aes(fill = resistance), position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  xlab("n beta-lactamases") +
  ylab("n strains") +
  theme(legend.title = element_blank()) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6))
```

#### Proportion


```{r}
#data_strain$resistance <- factor()

ggplot(data_strain, aes(n.beta.lac)) +
  geom_bar(aes(fill = resistance), position = "fill") +
  scale_fill_brewer(palette = "Set1") +
  xlab("n beta-lactamases") +
  ylab("proportion") +
  theme(legend.title = element_blank()) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6))
```

**OBS!** 

1. If number of BL-genes is higher than 3, the strain is more likely to be HR/R

2. There are `r nrow(data_strain %>% filter(n.beta.lac == 1, resistance == "HR"))` HR strain with only 1 beta-lactamase (which is *ampC*)

#### Proportion bar-plot

```{r}
ggplot(data_strain, aes(n.beta.lac.3)) +
  geom_bar(aes(fill = resistance), position = "fill") +
  scale_fill_brewer(palette = "Set1") +
  xlab("N beta-lact > 3") +
  ylab("proportion of strains") +
  scale_x_continuous(breaks = c(0,1), labels = c("0" = "No", "1" = "Yes"))+
  theme(legend.title = element_blank())
  
```

When the number of BL genes is less or equal 3, most likely the strains is non-HR

When number of BL genes is greater than 3, quite likely that the strain is HR or R

```{r}
ggplot(data_strain, aes(n.beta.lac.4)) +
  geom_bar(aes(fill=resistance), position = "fill") +
  scale_fill_brewer(palette="Set1") +
  xlab("N beta-lact > 4") +
  ylab("proportion of strains") +
  scale_x_continuous(breaks = c(0,1), labels = c("0" = "No", "1" = "Yes"))+
  theme(legend.title=element_blank())
```
 
Even more striking difference

### Beta-lactamases on plasmids and chromosome

Variable `n.genes.plasmids` means number of **beta-lactamases** on plasmids (it was renamed).

Let's check this.

It should always be less or equal than `n.beta.lac`.

How many strains in our data set `n.beta.lac` greater or equal `n.beta.lac.plasmid`: `r sum(data_strain$n.beta.lac >= data_strain$n.beta.lac.plasmid)`

How many strains in total: `r nrow(data_strain)`

These numbers must be equal.

#### Number of beta-lact on plasmids

```{r}
ggplot(data_strain, aes(n.beta.lac.plasmid)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  scale_x_continuous(breaks = c(0,1,2,3,4,5)) +
  xlab("n beta-lactamases on plasmids") +
  ylab("n strains")
```

Starting from 3 bl genes (on plasmids), it seems to be a very good predictor

#### Number of beta-lact on chrom

Classic bar plot

```{r}
ggplot(data_strain, aes(n.beta.lac.chrom)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  scale_x_continuous(breaks = c(0,1,2,3,4,5)) +
  xlab("n beta-lactamases on chromosome") +
  ylab("n strains")
```

As proportion:

```{r}
ggplot(data_strain, aes(n.beta.lac.chrom)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  scale_x_continuous(breaks = c(0,1,2,3,4,5)) +
  xlab("n beta-lactamases on chromosome") +
  ylab("proportion")
```


#### Proportion bar plot

```{r}
n_bl_loc <- data_strain %>% 
  select(resistance, n.beta.lac.plasmid, n.beta.lac.chrom) %>% 
  gather("loc", "N", 2:3) %>% 
  filter(N > 0)

bl_loc_sum <- n_bl_loc %>% 
  group_by(resistance, loc) %>% 
  summarise(sum.n = sum(N))

ggplot(bl_loc_sum, aes(loc, sum.n)) +
  geom_col(aes(fill = resistance), position = "fill") +
  scale_fill_brewer(palette = "Set1") +
  xlab("") +
  ylab("proportion") +
  scale_x_discrete(labels = c("on chromosome", "on plasmids")) +
  theme(legend.title = element_blank())
```

If a strain has BL genes on chromosome only it's more likely to be non-HR than HR

### Beta-lactamases on plus strand

#### Total

```{r}
ggplot(data_strain, aes(n.beta.lac.plus)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand") +
  ylab("n strains") 
```

As proportion


```{r}
ggplot(data_strain, aes(n.beta.lac.plus)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand") +
  ylab("proportion") 
```

#### On plasmids

```{r}
ggplot(data_strain, aes(n.beta.lac.plus.plasmid)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand on plasmids") +
  ylab("n strains") 
```

As proportion:

```{r}
ggplot(data_strain, aes(n.beta.lac.plus.plasmid)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand on plasmids") +
  ylab("proportion") 
```

#### On chromosomes

```{r}
ggplot(data_strain, aes(n.beta.lac.plus.chrom)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand on chromosome") +
  ylab("n strains") 
```

As proportion

```{r}
ggplot(data_strain, aes(n.beta.lac.plus.chrom)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n beta-lactamases on plus strand on chromosome") +
  ylab("proportion") 
```

### ampC and non-ampC beta-lactamases

```{r}
bl_type_count <- data_strain %>% 
  select(resistance, n.beta.lac, ampC.type.beta.lactamase) %>% 
  mutate(non.ampC = n.beta.lac - ampC.type.beta.lactamase) %>% 
  select(-n.beta.lac)

bl_type_count_tidy <- gather(bl_count, key = "gene", value = "n", 2:3) %>% 
  group_by(resistance, gene) %>% summarize(sum=sum(n))


ggplot(bl_type_count_tidy, aes(gene, sum))+
  geom_col(aes(fill=resistance), position = "fill", alpha = 1) + 
  # scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.7) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("") +
  ylab("proportion")+
  scale_x_discrete(labels = c("ampC", "non-ampC"))
  
```

Among strains having only ampC beta-lactamases, the majority is non-HR

Among strains having non-ampC beta-lactamases majority is HR or R

### ampC bar plot

```{r}
ggplot(data_strain, aes(ampC.type.beta.lactamase)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n ampC beta-lactamases") +
  ylab("n strains") 
```

As proportion:

```{r}
ggplot(data_strain, aes(ampC.type.beta.lactamase)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n ampC beta-lactamases") +
  ylab("proportoion") 
```

### non-ampC bar plot

```{r}
ggplot(bl_type_count, aes(non.ampC)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n non-ampC beta-lactamases") +
  ylab("n strains") 
```

As proportion

```{r}
ggplot(bl_type_count, aes(non.ampC)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("n non-ampC beta-lactamases") +
  ylab("proportion") 
```

## TEM beta-lactamase

```{r}
ggplot(data_strain, aes(TEM.beta.lactamase)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("TEM beta-lactamase") +
  ylab("n strains") 
```

As proportion:

```{r}
ggplot(data_strain, aes(TEM.beta.lactamase)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("TEM beta-lactamase") +
  ylab("proportion")
```


## Beta-lactamases heatmap

### AMR types in each strain

highlight BLs somehow!

```{r, fig.width=20, fig.height=6}
# This section is repeated in feature_engineering.Rmd

# get unique AMR types
amr_types <- unique(data$AMR.Gene.Family)

# get unique gene rows with AMR.Gene.Family
bl_amr_gene_types <- data %>% select(strain, record_id, AMR.Gene.Family) %>% distinct()

# make a DF of each AMR type counts in each gene
bl_blr_gene_presence <- as_tibble(
  as.data.frame(
    map(amr_types, function(x) ifelse(grepl(x, bl_amr_gene_types$AMR.Gene.Family, fixed = T), 1, 0)),
    col.names = amr_types))

# add strain and summarize counts
bl_blr_gene_presence$strain <- bl_amr_gene_types$strain
bl_blr_gene_presence <- relocate(bl_blr_gene_presence, strain, .before = "ampC.type.beta.lactamase")
# here sum is applied to all variables
bl_amr_types_strain <- bl_blr_gene_presence %>% group_by(strain) %>% summarise_each(~sum(.))
# we need shorter names
#names(bl_amr_types_strain) <- c("strain", "ampC", "DFR", "APH6", "APH3.1", "SUL", "TEM", "SAT", "ANT3", "MPH", "APH3.2", "CTX.M", "CAT", "AAC3", "OXA", "AAC6", "ANT2", "FTT", "SHV", "TR.RPP", "APH4", "QNR")

# make tidy for ggplot
bl_amr_types_strain_td <- gather(bl_amr_types_strain, key = "AMR.type", value = "N", 2:22)

# make a plot
ggplot(bl_amr_types_strain_td, aes(strain, AMR.type))+geom_tile(aes(fill=N))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, hjust=1, size = 4))+
  xlab("")+
  scale_fill_gradient2(high="blue")
```

*ampC* is present in every strain


## Number of plasmids

Per strain, doesn't depend on beta-lactamase presence or absence

### Box plot

```{r}
ggplot(data_strain, aes(resistance, n.plasmids)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T) +
  geom_jitter(alpha = 0.2, width = 0.15, height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ggtitle("") +
  ylab("n") +
  xlab("") +
  guides(fill = "none")
```

### Bar plot

```{r}
ggplot(data_strain, aes(n.plasmids)) +
  geom_bar(aes(fill = resistance), position = "dodge", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "")+
  xlab("n plasmids") +
  ylab("n strains")
```

## Median total repeat length

```{r}
med_rep_len <- data_strain %>% 
  select(resistance, med.tot.rep.len.chrom, med.tot.rep.len.plasmid, med.tot.rep.len) %>% 
  gather("location", "med.len", 2:4)

facet_names <- c("med.tot.rep.len.chrom" = "chromosome",
                 "med.tot.rep.len.plasmid" = "plasmids",
                 "med.tot.rep.len" = "total")

ggplot(med_rep_len %>% filter(med.len > 0), aes(resistance, med.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("avg repeat length") +
  xlab("") +
  guides(fill = "none")
```


### Average total

```{r}
ggplot(data_strain %>% filter(med.tot.rep.len > 0), aes(resistance, med.tot.rep.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("med repeat length") +
  xlab("") +
  guides(fill = "none")
```

### Average on chromosome

```{r}
ggplot(data_strain %>% filter(med.tot.rep.len.chrom > 0), aes(resistance, med.tot.rep.len.chrom)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("med repeat length") +
  xlab("") +
  guides(fill = "none")
```


### Average on plasmids

```{r}
ggplot(data_strain %>% filter(med.tot.rep.len.plasmid > 0), aes(resistance, med.tot.rep.len.plasmid)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("med repeat length") +
  xlab("") +
  guides(fill = "none")
```

## Median repeat length

```{r}
med_rep_len <- data_strain %>% 
  select(resistance, med.rep.len.chrom, med.rep.len.plasmid, med.rep.len) %>% 
  gather("location", "med.len", 2:4)

med_rep_len$med.len <- if_else(med_rep_len$med.len == 0, 1, med_rep_len$med.len)

facet_names <- c("med.rep.len.chrom" = "chromosome",
                 "med.rep.len.plasmid" = "plasmids",
                 "med.rep.len" = "total")

ggplot(med_rep_len %>% filter(med.len > 0), aes(resistance, med.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("median repeat length") +
  xlab("") +
  guides(fill = "none")
```


```{r}
ggplot(med_rep_len %>% filter(location == "med.rep.len.plasmid"), aes(resistance, med.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("median repeat length") +
  xlab("") +
  guides(fill = "none")
```


## Maximum repeat length

```{r}
max_rep_len <- data_strain %>% 
  select(resistance, max.rep.len.chrom, max.rep.len.plasmid, max.rep.len) %>% 
  gather("location", "max.len", 2:4)

max_rep_len$max.len <- if_else(max_rep_len$max.len == 0, 1, max_rep_len$max.len)

facet_names <- c("max.rep.len.chrom" = "chromosome",
                 "max.rep.len.plasmid" = "plasmids",
                 "max.rep.len" = "total")

ggplot(max_rep_len, aes(resistance, max.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("max repeat length") +
  xlab("") +
  guides(fill = "none")
```

```{r}
ggplot(max_rep_len %>% filter(location == "max.rep.len.plasmid"), aes(resistance, max.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("max repeat length") +
  xlab("") +
  guides(fill = "none")
```


## Repeat counts

```{r}
rep_count <- data_strain %>% 
  select(resistance, n.rep.chrom, n.rep.plasmid, n.rep.total) %>% 
  gather("location", "n.rep", 2:4)

rep_count$n.rep <- if_else(rep_count$n.rep == 0, 1, rep_count$n.rep) 

facet_names <- c("n.rep.chrom" = "chromosome",
                 "n.rep.plasmid" = "plasmids",
                 "n.rep.total" = "both")

ggplot(rep_count, aes(resistance, n.rep)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("n repeats") +
  xlab("") +
  guides(fill = "none")
```

```{r}
ggplot(rep_count %>% filter(location == "n.rep.plasmid"), aes(resistance, n.rep)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt")+
  ylab("n repeats") +
  xlab("") +
  guides(fill = "none")
```


## Amplifiable region size

```{r}
ar_len <- data_strain %>% 
  select(resistance, med.AR.len.chrom, med.AR.len.plasmid, med.AR.len) %>% 
  gather("location", "ar.len", 2:4)

facet_names <- c("med.AR.len.chrom" = "chromosome",
                 "med.AR.len.plasmid" = "plasmids",
                 "med.AR.len" = "both")

ggplot(ar_len %>% filter(ar.len > 0), aes(resistance, ar.len)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  #coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("avg AR length") +
  xlab("") +
  guides(fill = "none")
```

## Distance to oriC

### Min distance on chromnomsome, on plasmids, both

```{r}
min_ori <- data_strain %>% 
  select(resistance, min.dist.oriC.chrom, min.dist.oriC.plasmid, min.dist.oriC) %>% 
  gather("location", "dist", 2:4)

# for plots
min_ori$dist <- if_else(min_ori$dist == 0, 1, min_ori$dist)

facet_names <- c("min.dist.oriC.chrom" = "chromosome",
                 "min.dist.oriC.plasmid" = "plasmids",
                 "min.dist.oriC" = "both")

ggplot(min_ori, aes(resistance, dist)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  facet_grid(cols = vars(location), labeller = as_labeller(facet_names)) +
  ylab("min dist oriC") +
  xlab("") +
  guides(fill = "none")
```

```{r}
ggplot(min_ori %>% filter(location=="min.dist.oriC.plasmid"), aes(resistance, dist)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(aes(fill = resistance), alpha = 0.2, notch = F, varwidth = T, outlier.shape = NA) +
  geom_jitter(alpha = 0.2, width = 0.05, height = 0.1, size = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  coord_trans(y = "sqrt") +
  ylab("min dist oriC") +
  xlab("") +
  guides(fill = "none")
```


### Minimal distance on chromosome, on plasmids, both

```{r}

```


## Number of genes on plus strand

### On chromosome, on plasmids, both

```{r, fig.width=6, fig.height=4}
ggplot(data_strain, aes(n.genes.plus.strand))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of genes")+
  ylab("number of strains")+
  ggtitle("Beta-lactamase genes on plus-strand")
```


## ampC-type beta-lactamases

Statistics based on BL of ampC-type only

### Total repeat count

#### As a box plot

```{r, fig.width=6, fig.height=4}
ggplot(data_strain, aes(resistance, ampC.n.rep.tot))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC-type BL: total repeat count")+
  ylab("N")+
  guides(fill="none")
  
```

#### As a bar plot

```{r, fig.width=6, fig.height=4}
ggplot(data_strain, aes(ampC.n.rep.tot))+
  geom_area(aes(fill=resistance), stat="bin", alpha=0.6)+
  scale_fill_brewer(palette="Set1")+
  ggtitle("ampC-type BL: total repeat count distribution")+
  xlab("number of repeats")+
  ylab("number of strains")
```

### Median repeat length

```{r, fig.width=6, fig.height=4}
ggplot(data_strain %>% filter(ampC.med.rep.len > 0), aes(resistance, ampC.med.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median repeat length")+
  ylab("length")+
  guides(fill="none")
```

### Max repeat length

```{r, fig.width=6, fig.height=4}
ggplot(data_strain %>% filter(ampC.max.rep.len > 0), aes(resistance, ampC.max.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: max repeat length")+
  ylab("length")+
  guides(fill="none")
```


### Median sum of repeat lengths

```{r, warning=F, fig.width=6, fig.height=4}
ggplot(data_strain %>% filter(ampC.med.tot.rep.len > 0), aes(resistance, ampC.med.tot.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median sum of repeat lengths")+
  ylab("length")+
  guides(fill="none")
```


### Median AR size

```{r, fig.width=14}
plot.ampc.med.AR <- ggplot(data_strain %>% filter(ampC.med.AR.len > 0), aes(resistance, ampC.med.AR.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median AR size")+
  ylab("AR size")+
  guides(fill="none")

plot.ampc.med.AR.cen <- ggplot(data_strain %>% filter(ampC.med.AR.len.cen > 0), aes(resistance, ampC.med.AR.len.cen))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC-type BL: median AR size spanning gene center")+
  ylab("")+
  guides(fill="none")

ggarrange(plot.ampc.med.AR, plot.ampc.med.AR.cen, ncol=2, nrow=1, legend = "none")

```


------------------------------------------------------------------------

# Save the workspace

```{r, eval=TRUE}
save.image(f="/home/andrei/Data/HeteroR/notebooks/EDA_HR.RData")
```
