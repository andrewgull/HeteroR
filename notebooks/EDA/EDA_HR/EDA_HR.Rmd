---
title: "Exploratory Data Analysis of Pip/Tazo HR strains"
author: "by A.G."
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    toc: yes
    number_sections: true
    df_print: paged
    code_folding: hide
    fig_width: 10
    fig_height: 6
    theme: cerulean
    highlight: kate
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=5, message = F, warning = F, cache = T)
library(tidyverse)
#library(plotly)
library(ggpubr)
library(factoextra)
library(cluster)
# library(GGally)
# library(skimr)
# library(corrplot)
```

# Intro

Here I explore strains tested as HR and non-HR according to the most recent update from Karin.

AB is Piperacillin/Tazobactam

I use old `features_bl_strain` without separation between chromosomal and plasmid predictors.

I manually add resistance labels to features data table

---

# Read the data

Data set `features_bl_strain` has been made previously in `feature_engineering.Rmd`



Look at target class distribution

```{r, cache=F}
features_bl <- read_csv("/home/andrei/Data/HeteroR/results/tables/features_bl.csv")

features_bl_strain <- read_csv("data/features_bl_strain.csv", na = c("NA", "-Inf"))

hr_testing <- read_csv("data/heteroresistance_testing.csv")

hr_testing %>% group_by(resistance) %>% summarize(N=n())
```

Quite imbalanced target class

But, 120 strains out of 500 tested are not assembled yet and, out of 414 assembled strains, 47 are not tested...

```{r}
features_bl_strain %>% group_by(resistance) %>% summarize(N=n())
```

:(

## Some processing

Add BL genes counts as ordered factor and as binary features (if BL > 3)

Add new HR labels

Also, it seems reasonable to mege R and HR group, because of two reasons:

1. We have too little R

2. It is useful to predict whether a strains *is* (R) or *turns* (HR) resistant, because both outcomes require similar actions from a clinician.


```{r}
# BL counted as binary > 3
features_bl_strain$n.beta.lac.3 <- ifelse(features_bl_strain$n.beta.lac > 3, 1, 0)
features_bl_strain <- features_bl_strain %>% 
  relocate(n.beta.lac.3, .before="n.beta.lac")

# New target class and remove NA in resistance
features_bl_strain <- features_bl_strain %>% 
  select(-resistance) %>% 
  left_join(hr_testing, by = "strain") %>% 
  filter(!is.na(resistance))

features_bl_strain <- features_bl_strain %>% relocate(resistance, .before = "n.plasmids")

# merge R and HR into HR/R
features_bl_strain$resistance <- str_replace(features_bl_strain$resistance, "^R$", "HR/R")
features_bl_strain$resistance <- str_replace(features_bl_strain$resistance, "^HR$", "HR/R")

# resistance as factor
features_bl_strain$resistance <- as.factor(features_bl_strain$resistance)

# remove strain
# but keep them elsewhere
strains <- features_bl_strain$strain
features_bl_strain <- features_bl_strain %>% select(-strain)

features_bl_strain
```

# Descriptive stats

```{r}
skimr::skim(features_bl_strain)
```

non-HR: 265

HR/R: 79+13 = 91


There are strains with NAs, we can replace NA s with 0s

# Removing non-informative columns

```{r}
sum_cols <- apply(features_bl_strain[, -1], 2, function(x){sum(x, na.rm = T)})
sum_cols[sum_cols == 0]
```


Some columns contain only 0, I will remove them

```{r}
features_bl_strain <- features_bl_strain %>% 
  select(-DHA.beta.lactamase)
```


# Data imputation

`caret::preProcess()` doesn't have method for replacing with zeros...

```{r, cache=F}

features_bl_strain[is.na(features_bl_strain)] <- 0

```

# Write data for shiny app

```{r}
features_ptz_shiny <- features_bl_strain %>% 
  mutate("strain" = strains) %>% 
  relocate(strain, .before = resistance)

write.csv(features_ptz_shiny, "shiny/data/features_ptz_strain.csv", row.names = F)
```


# Data scaling

scale and center numeric features (real numeric + count, not dummies!)

```{r, cache=F}
end <- length(features_bl_strain)
# except for resistance and n.beta.lac.3
features_bl_strain_scaled <- as_tibble(
  scale(
    x = features_bl_strain %>% select(-c(resistance, n.beta.lac.3)),
    center = T, scale = T
    ))

features_bl_strain_scaled$resistance <- features_bl_strain$resistance
features_bl_strain_scaled$n.beta.lac.3 <- features_bl_strain$n.beta.lac.3

features_bl_strain_scaled <- relocate(features_bl_strain_scaled, n.beta.lac.3, .before="n.beta.lac")
features_bl_strain_scaled <- relocate(features_bl_strain_scaled, resistance, .before="n.plasmids")

# write it for modelling
write.csv(features_bl_strain_scaled, "../../modelling/PTZ_HR/data/features_ptz_hr_scaled.csv", row.names = F)
```


---


## Correlated predictors

```{r, fig.width=12, fig.height=12, cache=F}
# without resistance
cor_matrix <- cor(features_bl_strain[,c(2:end)], use = "pairwise.complete.obs")
corrplot::corrplot(cor_matrix, type="upper", tl.col = "black")
```


# Clustering

Let's do some clustering analysis on predictors.

Predictors should be standardized and imputed (they are).

## Dissimilarities heat map

Distance measure: Kendall's correlation

```{r, fig.width=10, fig.height=8}
feat_clust <- features_bl_strain_scaled %>% select(-resistance)
row.names(feat_clust) <- strains
#feat_clust <- features_bl_strain %>% select(-resistance)

distance <- get_dist(feat_clust, stand = F, method = "kendall")
fviz_dist(distance, gradient = list(low = "#bbab00", high = "#0000bb"), show_labels = T, lab_size = 6)
```

The darker is the color, the higher is dissimilarity

## k-means clustering

k = 2

```{r, fig.width=8, fig.height=6}
k2 <- kmeans(feat_clust, centers = 2, nstart = 100)
fviz_cluster(k2, data = feat_clust, repel = T, show.clust.cent = F, labelsize = 6)
```

### Correspondence between clusters and resistance

```{r}
feat_clust %>%
  mutate(cluster = k2$cluster, resistance = features_bl_strain$resistance) %>%
  select(resistance, cluster) %>% 
  table()
```


### Silhouette method

```{r, fig.width=6, fig.height=4}
fviz_nbclust(feat_clust, kmeans, method = "silhouette", diss = distance)
```

### Gap statistic

Suggests more clusters

```{r, fig.width=6, fig.height=4}
set.seed(123)
gap_stat <- clusGap(feat_clust, FUN = kmeans, nstart = 25,
                    K.max = 25, B = 50)

fviz_gap_stat(gap_stat)
```

???

# EDA

## RG counts distribution

### In strains tested for AMP

```{r, fig.width=6, fig.height=4}
rg_n_genes <- features_bl %>% select(strain, record_id) %>% distinct() %>% group_by(strain) %>% summarise(N=n())

ggplot(rg_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("RG count")+
  ylab("Strains count")+
  ggtitle("Resistance genes count distributiion")


```


```{r}
summary(rg_n_genes$N)
```

Same number as in the total data set.

### In strains with beta-lactamases genes only

```{r, fig.width=4, fig.height=3}
betaL_n_genes <- features_bl %>% 
  filter(grepl("beta-lactamase", AMR.Gene.Family)) %>% 
  select(strain, record_id) %>% 
  distinct() %>% 
  group_by(strain) %>% 
  summarise(N=n())

ggplot(betaL_n_genes, aes(N)) + 
  geom_histogram(fill="steelblue", binwidth = 1)+
  xlab("BL count")+
  ylab("Strains count")+
  ggtitle("Beta-lactamases genes count distribution")

```

```{r}
summary(betaL_n_genes$N)
```

Every strain has at least one beta-lactamase gene.

## Gene presence

This supposed to be the main predictor of HR

### Number of beta-lactamases


```{r, fig.width=6, fig.height=4}
# add resistance testing results
n_beta_lac <- left_join(betaL_n_genes, features_bl %>% 
                          select(strain, resistance) %>% 
                          distinct(), by="strain")
  
```

 
#### Bar plot 

because number of BL genes is count data.

```{r, fig.width=6, fig.height=4}
#features_bl_strain$resistance <- factor()

ggplot(features_bl_strain, aes(n.beta.lac))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("BL")+
  ylab("count")+
  ggtitle("Beta-lactamase genes count distribution")
```

If number of BL-genes is higher than 3, the strain is more likely to be HR/R

#### Proportion


```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain, aes(n.beta.lac.3)) +
  geom_bar(aes(fill=resistance), position="fill", alpha=0.8) +
  scale_fill_brewer(palette="Set1") +
  xlab("n.beta.lac > 3") +
  ylab("proportion") +
  scale_x_continuous(breaks =c(0,1), labels = c("0" = "No", "1" = "Yes"))
  
```

When the number of BL genes is less or equal 3, most likely the strains is non-HR

When number of BL genes is greater than 3, quite likely that the strain is HR or R

### Proportion of ampC beta-lactamases and other beta-lactamases in R and S strains

```{r, fig.width=6, fig.height=4}
bl_count <- features_bl_strain %>% 
  select(resistance, n.beta.lac, ampC.type.beta.lactamase) %>% 
  mutate(non.ampC = n.beta.lac - ampC.type.beta.lactamase) %>% 
  select(-n.beta.lac)

bl_count_tidy <- gather(bl_count, key = "gene", value = "n", 2:3) %>% 
  group_by(resistance, gene) %>% summarize(sum=sum(n))


ggplot(bl_count_tidy, aes(gene, sum))+
  geom_col(aes(fill=resistance), position = "fill", alpha=0.8) + 
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("BL-gene type") +
  ylab("proportion")
  
```

Among strains having only ampC beta-lactamases, the majority is non-HR

Among strains having non-ampC beta-lactamases majority is HR or R

## Beta-lactamases heatmap

### AMR types in each strain

highlight BLs somehow!

```{r, fig.width=20, fig.height=6}
# This section is repeated in feature_engineering.Rmd

# get unique AMR types
amr_types <- unique(features_bl$AMR.Gene.Family)

# get unique gene rows with AMR.Gene.Family
bl_amr_gene_types <- features_bl %>% select(strain, record_id, AMR.Gene.Family) %>% distinct()

# make a DF of each AMR type counts in each gene
bl_blr_gene_presence <- as_tibble(
  as.data.frame(
    map(amr_types, function(x) ifelse(grepl(x, bl_amr_gene_types$AMR.Gene.Family, fixed = T), 1, 0)),
    col.names = amr_types))

# add strain and summarize counts
bl_blr_gene_presence$strain <- bl_amr_gene_types$strain
bl_blr_gene_presence <- relocate(bl_blr_gene_presence, strain, .before = "ampC.type.beta.lactamase")
# here sum is applied to all variables
bl_amr_types_strain <- bl_blr_gene_presence %>% group_by(strain) %>% summarise_each(~sum(.))
# we need shorter names
#names(bl_amr_types_strain) <- c("strain", "ampC", "DFR", "APH6", "APH3.1", "SUL", "TEM", "SAT", "ANT3", "MPH", "APH3.2", "CTX.M", "CAT", "AAC3", "OXA", "AAC6", "ANT2", "FTT", "SHV", "TR.RPP", "APH4", "QNR")

# make tidy for ggplot
bl_amr_types_strain_td <- gather(bl_amr_types_strain, key = "AMR.type", value = "N", 2:22)

# make a plot
ggplot(bl_amr_types_strain_td, aes(strain, AMR.type))+geom_tile(aes(fill=N))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, hjust=1, size = 4))+
  xlab("")+
  scale_fill_gradient2(high="blue")
```

*ampC* is present in every strain


### Beta-lactamases types per gene

There are too many genes to visualize this heat map properly

```{r, fig.width=30, fig.height=6, eval=F}
# add record_id
amp_ampr_gene_presence$record_id <- amp_amr_gene_types$record_id
amp_ampr_gene_presence <- relocate(amp_ampr_gene_presence, record_id, .before="ampC.type.beta.lactamase")

# names
names(amp_ampr_gene_presence) <- c("strain", "record_id" , "ampC", "DFR", "APH6", "APH3.1", "SUL", "TEM", "SAT", "ANT3", "MPH", "APH3.2", "CTX.M", "CAT", "AAC3", "OXA", "AAC6", "ANT2", "FTT", "SHV", "TR.RPP", "APH4", "QNR")

# make it tidy
amp_ampr_gene_presence_td <- gather(amp_ampr_gene_presence, key="AMR.type", value="N", 3:23)
amp_ampr_gene_presence_td$N <- factor(amp_ampr_gene_presence_td$N, ordered=T, levels=c(0,1))

# make a plot
ggplot(amp_ampr_gene_presence_td, aes(record_id, AMR.type))+geom_tile(aes(fill=N))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, hjust=1, size = 0.1))+
  xlab("")+
  scale_fill_discrete(type=c("white", "steelblue"))
  
```


## Number of plasmids

Per strain, doesn't depend on beta-lactamase presence or absence

```{r, fig.width=10, fig.height=6}
plot.n.plasm.box <- ggplot(features_bl_strain, aes(resistance, n.plasmids))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("")+
  ylab("N")+
  guides(fill="none")

plot.n.plasm.bar <- ggplot(features_bl_strain, aes(n.plasmids))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of plasmids")+
  ylab("number of strains")

ggarrange(plot.n.plasm.box, plot.n.plasm.bar,
          ncol=2, nrow=1, 
          common.legend = T, legend = "bottom")

```


## Number of genes on plasmids

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain, aes(n.genes.plasmids))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of genes")+
  ylab("number of strains")+
  ggtitle("Beta-lactamase genes on plasmids")
```

Starting from 5 genes, it seems to be a very good predictor


## Repeat length: all repeats


### Average total, average on chromosome, average on plasmids


```{r, fig.height=6, fig.width=14}

```

## Repeat length: repeats longer than 100 bp

### Average on chromosome, average on plasmids, both

```{r, fig.height=6, fig.width=14}


```

## Sum repeat length

### On chromosome, on plasmids, both

```{r, warning=F, fig.width=6, fig.height=4}
ggplot(features_bl_strain %>% filter(med.tot.rep.len > 0), aes(resistance, med.tot.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set1") +
  xlab("")+ylab("length") +
  ggtitle("Sum repeat length")+
  guides(fill="none")

```

## Maximum repeat length

some zeros are removed for plotting purposes

### On chromosome, on plasmids, both

```{r, fig.width=14, fig.height=6}

```


## Repeat counts

### On chromosome, on plasmids, both

```{r, fig.width=14, fig.height=6}
plot.rc.total <- ggplot(features_bl_strain, aes(resistance, n.rep.total)) +
  geom_violin(aes(fill=resistance), alpha=0.7) +
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T) +
  geom_jitter(alpha=0.2, width=0.15, height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ylab("N") +
  xlab("") +
  ggtitle("Number of repeats in total")

plot.rc.chrom <- ggplot(features_bl_strain, aes(resistance, n.rep.chrom)) +
  geom_violin(aes(fill=resistance), alpha=0.7) +
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T) +
  geom_jitter(alpha=0.2, width=0.15, height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ylab("") +
  xlab("") +
  ggtitle("Number of repeats on chromosome")

plot.rc.plasm <- ggplot(features_bl_strain, aes(resistance, n.rep.plasmid)) +
  geom_violin(aes(fill=resistance), alpha=0.7) +
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T) +
  geom_jitter(alpha=0.2, width=0.15, height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ylab("") +
  xlab("") +
  ggtitle("Number of repeats on plasmids")
  

  
ggarrange(plot.rc.total, plot.rc.chrom, plot.rc.plasm,
          ncol=3, nrow=1, 
          common.legend = T, legend = "none")
```

## Amplifiable region size

### On chromosome, on plasmids both

```{r, fig.height=6, fig.width=14}

```


## Distance to oriC

### Median distance on chromnomsome, on plasmids, both

```{r}
plot.min.dist.oric <- ggplot(features_bl_strain, aes(resistance, min.dist.oriC))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("Minimal dist to oriC")+
  coord_trans(y="sqrt") +
  ylab("distance")+
  xlab("") +
  guides(fill="none")

plot.med.dist.oric <- ggplot(features_bl_strain, aes(resistance, med.dist.oriC))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("Median dist to oriC")+
  coord_trans(y="sqrt") +
  ylab("")+
  xlab("") +
  guides(fill="none")


ggarrange(plot.min.dist.oric, plot.med.dist.oric, ncol=2, nrow=1, legend = "none")
```


### Minimal distance on chromosome, on plasmids, both

```{r}

```


## Number of genes on plus strand

### On chromosome, on plasmids, both

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain, aes(n.genes.plus.strand))+
  geom_bar(aes(fill=resistance), position="dodge", alpha=0.8)+
  scale_fill_brewer(palette="Set1")+
  xlab("number of genes")+
  ylab("number of strains")+
  ggtitle("Beta-lactamase genes on plus-strand")
```


## ampC-type beta-lactamases

Statistics based on BL of ampC-type only

### Total repeat count

#### As a box plot

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain, aes(resistance, ampC.n.rep.tot))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC-type BL: total repeat count")+
  ylab("N")+
  guides(fill="none")
  
```

#### As a bar plot

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain, aes(ampC.n.rep.tot))+
  geom_area(aes(fill=resistance), stat="bin", alpha=0.6)+
  scale_fill_brewer(palette="Set1")+
  ggtitle("ampC-type BL: total repeat count distribution")+
  xlab("number of repeats")+
  ylab("number of strains")
```

### Median repeat length

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain %>% filter(ampC.med.rep.len > 0), aes(resistance, ampC.med.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median repeat length")+
  ylab("length")+
  guides(fill="none")
```

### Max repeat length

```{r, fig.width=6, fig.height=4}
ggplot(features_bl_strain %>% filter(ampC.max.rep.len > 0), aes(resistance, ampC.max.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: max repeat length")+
  ylab("length")+
  guides(fill="none")
```


### Median sum of repeat lengths

```{r, warning=F, fig.width=6, fig.height=4}
ggplot(features_bl_strain %>% filter(ampC.med.tot.rep.len > 0), aes(resistance, ampC.med.tot.rep.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = F, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median sum of repeat lengths")+
  ylab("length")+
  guides(fill="none")
```


### Median AR size

```{r, fig.width=14}
plot.ampc.med.AR <- ggplot(features_bl_strain %>% filter(ampC.med.AR.len > 0), aes(resistance, ampC.med.AR.len))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  coord_trans(y="sqrt") +
  ggtitle("ampC-type BL: median AR size")+
  ylab("AR size")+
  guides(fill="none")

plot.ampc.med.AR.cen <- ggplot(features_bl_strain %>% filter(ampC.med.AR.len.cen > 0), aes(resistance, ampC.med.AR.len.cen))+
  geom_violin(aes(fill=resistance), alpha=0.7)+
  geom_boxplot(aes(fill=resistance), alpha=0.2, notch = T, varwidth = T)+
  geom_jitter(alpha=0.2, width=0.15, height = 0.1)+
  scale_fill_brewer(palette = "Set1")+
  ggtitle("ampC-type BL: median AR size spanning gene center")+
  ylab("")+
  guides(fill="none")

ggarrange(plot.ampc.med.AR, plot.ampc.med.AR.cen, ncol=2, nrow=1, legend = "none")

```


------------------------------------------------------------------------

# Save the workspace

```{r, eval=TRUE}
save.image(f="/home/andrei/Data/HeteroR/notebooks/EDA_HR.RData")
```
