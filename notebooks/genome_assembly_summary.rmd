---
title: "Genome assemblies summary"
author: "AG"
date: "last update: `r format(Sys.time(), format = '%d %B %Y, %H:%M CET')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    rmdformats:
      theme: cerulean
      highlight: github
---

Here you'll find a summary of `results/assemblies_joined/{strain}/summary.tsv` files

# Read the data

```{r, message = FALSE, warning = FALSE}
library(dplyr)

# just in case
setwd("/home/andrei/Data/HeteroR/notebooks")

summary_files <- dir(path="../results/assemblies_joined",  pattern = "summary.tsv", recursive=TRUE)
summary_table <- lapply(summary_files, function(x){read.delim(paste0("../results/assemblies_joined/", x), stringsAsFactors = TRUE)})

summary_table <- bind_rows(summary_table)
# replace commas in Length, N50 and Longest component
summary_table$Length <- as.integer(gsub(",", "", summary_table$Length, fixed=TRUE))
summary_table$N50 <- as.integer(gsub(",", "", summary_table$N50, fixed=TRUE))
summary_table$Longest_component <- as.integer(gsub(",", "", summary_table$Longest_component, fixed=TRUE))
summary_table
```

# Summaries
```{r}
summary(summary_table)
```

## Number of plasmids per strain

```{r, message = FALSE}
plasmids_count <- summary_table %>% group_by(Strain, Type) %>% summarise(Count = n()) %>% filter(Type=="Plasmid")
plasmids_count
```


```{r, warning = FALSE, message = FALSE, fig.width = 14, fig.asp = 0.6}
library(ggplot2)

plot_plasmids_per_strain <- ggplot(plasmids_count, aes(reorder(Strain, -Count), Count)) + geom_col() +
        theme(axis.text.x = element_text(size = 7, angle = 90)) +
        scale_y_continuous(breaks=seq(0, 10, 1)) +
        xlab("strains") +
        ylab("plasmids count")
plot_plasmids_per_strain
```

```{r}
ggplot(plasmids_count, aes(Type, Count)) +
        geom_boxplot() +
        geom_jitter() +
        scale_y_continuous(breaks=seq(0, 11, 2)) +
        xlab("") +
        ylab("plasmid count")
```

## Number of complete and incomplete segments per strain

```{r, warning = FALSE, message = FALSE}
complete_incomplete <- summary_table %>% group_by(Strain, Status) %>% summarise(Count = n())
complete_incomplete
```
```{r, warning = FALSE, message = FALSE, fig.width = 14, fig.asp = 0.6}
plot_complete_incomplete <- ggplot(complete_incomplete, aes(reorder(Strain, -Count), Count)) +
         geom_col(aes(fill=Status), position = "stack") +
        theme(axis.text.x = element_text(size = 7, angle = 90)) +
        xlab("strain") +
        ylab("count")

plot_complete_incomplete
```

"complete" - circular assembly (Unicycler)

"incomplete" - linear assembly (Unicycler)

"scaffold" - linear assembly (SPAdes plasmid)

There is indeed just one scaffold, i.e. plasmid assembles by SPAdes

```{r}
summary_table %>% filter(Status=="scaffold")
```

## Genome length distribution

### Chromosomes

```{r, warning = FALSE, message = FALSE}
summary_chrom <- summary_table %>% filter(Type=='Chromosome')
plot_length_chrom <- ggplot(summary_chrom, aes(Length)) + geom_histogram(stat="bin")
plot_length_chrom
```

### Plasmids

```{r}
summary_plasmids <- summary_table %>% filter(Type=='Plasmid')
plot_length_plasmid <- ggplot(summary_plasmids, aes(Length)) + geom_histogram(stat="bin")
plot_length_plasmid
```

These longest outliers (250k, 400k, 700k and 900k) - are they really plasmids?
```{r}
summary_table %>% filter(Type=='Plasmid') %>% arrange(-Length)
```
```{r}
summary_table %>% filter(Strain=="DA63676")
```

Chromosome is incomplete and adds up to 5 Mbp with the longest plasmid...

```{r}
summary_table %>% filter(Strain=="DA63914")
```

Same here...

# Assembly completeness

Parse BUSCO summary files and summarize the results

```{r}
busco_path <- "/home/andrei/Data/HeteroR/results/qualcheck_assembly/"
busco_filename <- "short_summary.specific.gammaproteobacteria_odb10.busco_results.txt"

busco_files <- dir(path = busco_path, pattern = busco_filename, recursive = TRUE)

busco_list <- lapply(busco_files, function(x){
  strain <- strsplit(x, "/")[[1]][1]
  t <- read.delim(paste0(busco_path, x), skip = 9, header = FALSE, nrows = 6)
  t$Strain <- strain
  return(t)
})

busco_table <- bind_rows(busco_list) %>% select(-c(V1, V4, V5, V6))

busco_table
```

## Distribution of complete BUSCOs

### Complete

```{r}
busco_table %>% filter(V3 == "Complete BUSCOs (C)") %>% summary()
```

### Complete and single-copy

```{r}
busco_table %>% filter(V3 == "Complete and single-copy BUSCOs (S)") %>% summary()
```

### Fragmented

```{r}
busco_table %>% filter(V3 == "Fragmented BUSCOs (F)") %>% summary()
```

### Missing

```{r}
busco_table %>% filter(V3 == "Missing BUSCOs (MFragmented)") %>% summary()
```

