---
title: "On the reasons of incomplete assemblies"
author: "AG"
date: "last update: `r format(Sys.time(), format = '%d %B %Y, %H:%M CET')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    rmdformats:
      theme: cerulean
      highlight: github
---

# Introduction

Having analysed assemblies' summaries I found out that a lot of them (n=89) are incomplete, i.e. not circularised by Unicycler.
One possible reason can be that they were trimmed to harshly by *filtlong*.

![Fig.1 Assembly completeness as reported by Unicycler](../images/assembly_completeness_barplot.png)

I have a table with incomplete assemblies
```{r}
library(dplyr)

# just in case
my_path <- "/home/andrei/Data/HeteroR/results/assemblies_joined"

summary_files <- dir(path=my_path,  pattern = "summary.tsv", recursive=TRUE)
summary_table <- lapply(summary_files, function(x){read.delim(paste0("results/assemblies_joined/", x), stringsAsFactors = TRUE)})

summary_table <- bind_rows(summary_table)
# replace commas in Length, N50 and Longest component
summary_table$Length <- as.integer(gsub(",", "", summary_table$Length, fixed=TRUE))
summary_table$N50 <- as.integer(gsub(",", "", summary_table$N50, fixed=TRUE))
summary_table$Longest_component <- as.integer(gsub(",", "", summary_table$Longest_component, fixed=TRUE))
summary_table
```
```{r eval=FALSE}
write.delim(summary_table %>% filter(Status == "incomplete"), "/home/andrei/Data/HeteroR/incomplete_assemblies.tsv", sep="\t", quote=F)
```
```{r}
incomplete_assemblies <- read.delim("/home/andrei/Data/HeteroR/incomplete_assemblies.tsv")
incomplete_assemblies
```

Then I ran *coverage.py* on both raw and filtered Nanopore reads in hope to capture the difference...

```
python  workflow/scripts/coverage.py resources/strain_lists/incomplete_assemblies_strains_80.txt 5131220 results/coverage/incomplete_assemblies_strains_80_coverage.tsv raw
python  workflow/scripts/coverage.py resources/strain_lists/incomplete_assemblies_strains_80.txt 5131220 results/coverage/incomplete_assemblies_strains_80_coverage_filtered.tsv filtered
```

Let's look at results

```{r}
coverage_raw <- read.delim("/home/andrei/Data/HeteroR/results/coverage/incomplete_assemblies_strains_80_coverage.tsv")
coverage_raw$strain <- sapply(coverage_raw$file, function(x){strsplit(x, "/")[[1]][3]})
coverage_raw$filtered <- "no"

coverage_filtered <- read.delim("/home/andrei/Data/HeteroR/results/coverage/incomplete_assemblies_strains_80_coverage_filtered.tsv")
coverage_filtered$strain <- sapply(coverage_filtered$file, function(x){strsplit(x, "/")[[1]][3]})
coverage_filtered <- select(coverage_filtered, -c(file, format, type))
coverage_filtered$filtered <- "yes"

coverage_joined <- bind_rows(coverage_raw, coverage_filtered)
coverage_joined <- select(coverage_joined, -c(file, format, type))
coverage_joined
```

# Plots

## Number of sequences

```{r}
library(ggplot2)

ggplot(coverage_joined, aes(strain, num_seqs))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Number of reads")+
        ylab("")+
        xlab("")

#+coord_trans(y="sqrt")
```

## Coverage

```{r}
ggplot(coverage_joined, aes(strain, coverage))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Coverage")+
        ylab("")+
        xlab("")

```

## Summary length

```{r}
ggplot(coverage_joined, aes(strain, sum_len))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Total read length")+
        ylab("")+
        xlab("")
```

## Minimum length

```{r}
ggplot(coverage_joined, aes(strain, min_len))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Minimum read length")+
        ylab("")+
        xlab("")
```

## Average length

```{r}
ggplot(coverage_joined, aes(strain, avg_len))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Average read length")+
        ylab("")+
        xlab("")
```

## Maximum length

```{r}
ggplot(coverage_joined, aes(strain, max_len))+
         geom_col(aes(fill=filtered), position="dodge")+
        theme(axis.text.x = element_text(size = 7, angle = 90))+
        ggtitle("Maximum read length")+
        ylab("")+
        xlab("")
```
Max length didn't suffer much, while minimum and average lengths actually improved

filtlong command looks like this:
```
filtlong --min_length 5000 --length_weight 1 --keep_percent 20 --target_bases 260000000 {input} 2> {log} | pigz -c -p {threads} > {output}
```