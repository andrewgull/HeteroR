---
title: "Prediction of incomplete assemblies"
author: "AG"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
    code_folding: hide
    fig_width: 10
    fig_height: 6
    theme: cerulean
    highlight: kate
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, fig.height = 5, message = F, warning = F)

library(tidyverse)
library(GGally)
library(caret)

```

Now, when I have more data on incomplete and complete assemblies, I can build a better model
predicting assembly completeness.

# Nanopore coverage

## Get coverage data

Get table with coverage using your python script from HeteroR workflow

```{bash, eval=FALSE}
# run from ~/Data/HeteroR

python workflow/scripts/coverage.py nanopore_sequenced_strains.txt 5131220 results/coverage/nanopore_sequenced_strains_raw.tsv raw

python workflow/scripts/coverage.py nanopore_sequenced_strains.txt 5131220 results/coverage/nanopore_sequenced_strains_raw.tsv filtered

```

Read the results and add completeness information

## Read raw coverage data

```{r}
nano_cov_raw <- read_delim("~/Data/HeteroR/results/coverage/nanopore_sequenced_strains_raw.tsv")
nano_cov_raw$strain <- str_extract(nano_cov_raw$file, "DA[0-9]*")
nano_cov_raw <- relocate(nano_cov_raw, strain, .before = "file")
nano_cov_raw$filtered <- "raw"

nano_cov_raw
```

## Read filtered coverage data

```{r}
nano_cov_filtered <- read_delim("~/Data/HeteroR/results/coverage/nanopore_sequenced_strains_filtered.tsv")
nano_cov_filtered$strain <- str_extract(nano_cov_filtered$file, "DA[0-9]*")
nano_cov_filtered <- relocate(nano_cov_filtered, strain, .before = "file")
nano_cov_filtered$filtered <- "filt"

nano_cov_filtered
```

## Join them together

```{r}
nano_cov <- bind_rows(nano_cov_filtered, nano_cov_raw)

nano_cov
```

## Add chromosome completeness data

```{r}
assemblies_summary <- read_csv("~/Data/HeteroR/results/tables/genome_assembly_summary.csv")
assemblies_summary <- assemblies_summary %>% 
  select(Length, N50, Longest_component, Status, Status2, Strain, Type) %>% 
  filter(Type == "Chromosome") %>% 
  distinct() %>% 
  rename(strain="Strain")

assemblies_summary
```

```{r}
nano_cov <- left_join(nano_cov, assemblies_summary, by="strain")

nano_cov
```

## Plot

```{r}
ggplot(nano_cov %>% filter(!is.na(Status)), aes(filtered, coverage))+
  geom_boxplot(aes(fill=Status), varwidth = T, notch = T)+
  coord_trans(y="sqrt")
```

# Write strains that should be resequenced to file

```{r}
nano_cov %>% filter(filtered=="filt", Status == "incomplete") %>% arrange(coverage)
```


```{r}
strains_incomplete_filt <- nano_cov %>% 
  filter(filtered=="filt", Status == "incomplete") %>% 
  arrange(coverage) %>% 
  select(strain, coverage)

strains_incomplete_raw <- nano_cov %>% 
  filter(filtered=="raw", Status == "incomplete") %>% 
  arrange(coverage) %>% 
  select(strain, coverage)

strains_incomplete <- full_join(strains_incomplete_filt, strains_incomplete_raw, by="strain")

write.csv(strains_incomplete, "~/Data/HeteroR/results/tables/incomplete_assemblies.csv", row.names = F)
```

# Predict completeness of assembly

Attempt number 2, on a bigger data set.

Add raw data statistics to assemblies summary

## Get data

```{r}
library(caret)

my_data <- left_join(
  select(assemblies_summary, c(strain, Status)),
  select(nano_cov_raw, c(strain, num_seqs, sum_len, min_len, avg_len, max_len, coverage)),
  by="strain"
  )

my_data$Status <- as.factor(my_data$Status)
#my_data$sum_len_log <- log(my_data$sum_len)

summary(my_data)
```

## Make tidy

```{r}
my_data_td <- my_data  %>% gather(key="statistic", value="value", 3:8)
```

## Box plots

```{r, fig.width=10}
ggplot(my_data_td, aes(Status, value))+
  geom_boxplot(varwidth = T, aes(fill=Status))+
  coord_trans(y="log")+
  facet_grid(. ~ statistic)+
  scale_fill_brewer(palette = "Set1")+
  xlab("")+
  ylab("")
```

## Pairs plot

```{r, fig.width=10}
library(GGally)
ggpairs(my_data, 
        columns=c(3:8), 
        aes(color=Status, alpha=0.2, dotsize=0.02), 
        upper = list(continuous = wrap("cor", size = 2.5)),
        diag=list(continuous ="barDiag"))+
  scale_color_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")

```

## Model

```{r}
set.seed(100)

inTrain <- createDataPartition(y = my_data$Status, p=0.7, list=FALSE)

training <- my_data[inTrain,]
testing <- my_data[-inTrain,]

```
