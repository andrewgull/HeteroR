---
title: "Repeat Summary"
author: "AG"
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    rmdformats:
      theme: readthedown
      highlight: github
---

This notebook relies on results from *make_repeat_tables.py* that creates tables which contain
coordinates of repeat for each strain and each resistance gene

From here on I will work with data from this table

Read the data, currently it contains 238 strains

```{r}
# a new way of getting repeat data frame across all strains
library(dplyr)
strains <- dir("results/direct_repeats")
repeat_csv_paths <- sapply(strains, function(x){paste0("results/annotations/",x ,"/repeats/", x, "_repeats.csv")})

repeat_df <- bind_rows(lapply(repeat_csv_paths, function(x){read.csv(x)}))
head(repeat_df)
```

Table size

```{r}
dim(repeat_df)
```

Filter duplicates

There is no identical coordinate pairs (if you consider gene name as well)

```{r}
repeat_df_dedup <- repeat_df %>% distinct(record_id, start_1, end_1, start_2, end_2, .keep_all = TRUE)
dim(repeat_df_dedup)
```

Number of strains

```{r}
length(unique(repeat_df$strain))
```

Sample 20 strains

```{r}
library(dplyr)

set.seed(99)
strains <- unique(repeat_df$strain)
strains_sample <- sample(strains, 20, replace = FALSE)
sample_df <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df, strain == x)
        })
)
dim(sample_df)
```


```{r}
sample_df
```

## Repeat lengths distribution

```{r}
library(ggplot2)

ggplot(sample_df, aes(strain, length)) +
        geom_boxplot(outlier.size = 1.0, outlier.alpha = 0.2, size=0.2) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeat length") +
        scale_y_continuous(breaks=c(20, 100, 500, 1000, 2000, 4000, 6000), trans="log")
```

## Repeat count per strain

```{r}
repeat_counts <- sample_df %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r}
ggplot(repeat_counts, aes(strain, n_repeats)) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeats count")
```

## Repeat count distribution around each RG

```{r}
repeat_counts <- sample_df %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r}
ggplot(repeat_counts, aes(strain, n_repeats)) +
        geom_boxplot(outlier.size = 1.0, outlier.alpha = 0.5, size=0.2) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeat counts per RG") +
        coord_trans(y="sqrt") +
        scale_y_continuous(breaks=c(1, 10, 20, 50, 100, 500, 1000, 2000))
```

## Distances between repeat pairs aka "AR length"
```{r}
repeat_df$AR_length <- repeat_df$start_2 - repeat_df$end_1
sample_df$AR_length <- sample_df$start_2 - sample_df$end_1
head(repeat_df)
```

```{r}
ggplot(sample_df, aes(strain, AR_length)) +
        geom_boxplot(alpha=0.5, outlier.size = 1.0, outlier.alpha = 0.5, size=0.2) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("AR length")
```

# Filter out repeats not spanning the center of every range

the middle of the range is the middle of the RG
Those repeats that are on one side of it, are not interesting for us because they don't affect amplifications rate

I need bed files: regions_within.bed
there I can find regions around RGs - to find the middle of each region

files are here:

`results/direct_repeats/DA*/regions/regions_within.bed`

```{r}
bed_df <- bind_rows(lapply(strains, function (x){
  filename <- paste0("/home/andrei/Data/HeteroR/results/direct_repeats/", x, "/regions/regions_within.bed")
  df <- read.delim(filename, header=FALSE)
  return(df)
}))

bed_df$gene_center <- round((bed_df$V3 - bed_df$V2 + 1)/2)
bed_df <- rename(bed_df, "record_id"=V4)
bed_df <- select(bed_df, record_id, gene_center)

head(bed_df)
```

Number of unique gene names equals number of rows in bed_df
Which means I can join bed and repeats tables using gene names only

```{r}
length(unique(bed_df$record_id)) == nrow(bed_df)
```


```{r}
# example
#DA63746_bed <- read.delim("/home/andrei/Data/HeteroR/results/direct_repeats/DA63746/regions/regions_within.bed", header=FALSE)
#DA63746_bed$gene_center <- round((DA63746_bed$V3 - DA63746_bed$V2 + 1)/2)
#DA63746_bed <- rename(DA63746_bed, "record_id"=V4)
#DA63746_bed <- select(DA63746_bed, record_id, gene_center)

#DA63746_df <- filter(repeat_df, strain=="DA63746")
#DA63746_df <- full_join(DA63746_bed, DA63746_df, by="record_id")
#DA63746_df$spans_center <- if_else(DA63746_df$end_1 <= DA63746_df$gene_center & DA63746_df$start_2 >= DA63746_df$gene_center, "yes", "no")
#DA63746_df

repeat_df <- full_join(bed_df, repeat_df, by="record_id")
repeat_df$spans_center <- if_else(repeat_df$end_1 <= repeat_df$gene_center & repeat_df$start_2 >= repeat_df$gene_center, "yes", "no")

head(repeat_df, n=20)
```
```{r}
repeat_df_center <- repeat_df %>% filter(spans_center == "yes")
length(unique(repeat_df_center$strain))
```

All strains have at least one repeat pair spanning gene center

# Only repeats spanning RG's center

get sample

```{r}
sample_df_center <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df_center, strain == x)
        })
)
dim(sample_df_center)
```

## Repeat length

```{r}
ggplot(sample_df_center, aes(strain, length)) +
        geom_boxplot(outlier.size = 1.0, outlier.alpha = 0.2, size=0.2, varwidth = TRUE) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeat length") +
        scale_y_continuous(breaks=c(20, 100, 500, 1000, 2000, 4000, 5000), trans="log")
```

## Repeat counts

```{r}
repeat_counts_center <- sample_df_center %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts_center
```

```{r}
ggplot(repeat_counts_center, aes(strain, n_repeats)) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeats count")
```

## Repeat numbers around each RG
```{r}
repeat_counts_center2 <- sample_df_center %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())

ggplot(repeat_counts_center2, aes(strain, n_repeats)) +
        geom_boxplot(outlier.size = 1.0, outlier.alpha = 0.5, size=0.2, varwidth=TRUE) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("repeat counts per RG") +
        coord_trans(y="sqrt") +
        scale_y_continuous(breaks=c(1, 10, 20, 50, 100, 500, 1000, 2000))
```

## AR length distribution

```{r}
ggplot(sample_df_center, aes(strain, AR_length)) +
        geom_boxplot(alpha=0.5, outlier.size = 1.0, outlier.alpha = 0.5, size=0.2, varwidth=TRUE) +
        geom_violin(alpha=0.2, size=0.2) +
        theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
        xlab("") +
        ylab("AR length")
```
