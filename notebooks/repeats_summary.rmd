---
title: "Repeat Summary"
author: "by A.G."
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    fig_width: 10
    fig_height: 6
    code_folding: hide
    df_print: paged
    toc: true
    number_sections: true
    toc_float: true
    theme: cerulean 
    highlight: kate
---

```{r, include=F}
knitr::opts_chunk$set(fig.width=10, fig.height=5)
library(dplyr)
library(tidyr)
library(plotly)
library(ggplot2)
library(ggpubr)
```

This notebook relies on results from *make_repeat_tables.py* that creates tables with coordinates of repeats for each strain and each resistance gene

UPDATE: other predictor-related analysis will also be here.

# Make a table of all repeat tables

```{r, message = FALSE, warning = FALSE, cache=TRUE}
# a new way of getting repeat data frame across all strains
strains <- dir("/home/andrei/Data/HeteroR/results/direct_repeats")
repeat_csv_paths <- sapply(strains, function(x){paste0("/home/andrei/Data/HeteroR/results/annotations/",x ,"/repeats/", x, "_repeats.csv")})

repeat_df <- bind_rows(lapply(repeat_csv_paths, function(x){read.csv(x)}))
# calculate AR length
repeat_df$AR_length <- repeat_df$start_2 - repeat_df$end_1

repeat_df
```

Number of rows: `r nrow(repeat_df)`

Number of strains: `r length(unique(repeat_df$strain))`

## Filter duplicates

There is no identical coordinate pairs (if you consider gene name as well)

```{r}
repeat_df_dedup <- repeat_df %>% distinct(record_id, start_1, end_1, start_2, end_2, .keep_all = TRUE)

```

Number of rows: `r nrow(repeat_df_dedup)`

Number of strains: `r length(unique(repeat_df_dedup$strain))`

## Sample 40 strains

To see fully interactive plots, go check `shiny_apps` or change the sample size and seed value.

```{r}
set.seed(99)

strains <- unique(repeat_df$strain)
strains_sample <- sample(strains, 40, replace = FALSE)

sample_df <- filter(repeat_df, strain %in% strains_sample)

sample_df
```

# Label repeats spanning their gene's center

The middle of the range is the middle of the RG.

Those repeats that are located on the same side of it, are not interesting for us because they don't affect amplifications rate

To get repeat coordinates I need bed files: regions_within.bed

The files are here:

`results/direct_repeats/DA*/regions/regions_within.bed`

```{r, cache=TRUE}
bed_df <- bind_rows(lapply(strains, function (x){
  filename <- paste0("/home/andrei/Data/HeteroR/results/direct_repeats/", x, "/regions/regions_within.bed")
  df <- read.delim(filename, header=FALSE)
  return(df)
}))

bed_df$gene_center <- round((bed_df$V3 - bed_df$V2 + 1)/2)
bed_df <- rename(bed_df, "record_id"=V4)
bed_df <- select(bed_df, record_id, gene_center)

bed_df
```

Number of gene names: `r length(unique(bed_df$record_id))`

Number of rows: `r nrow(bed_df)`

Number of unique gene names equals number of rows in bed_df, which means I can join bed and repeats tables using gene names only

## Joined repeat summary table and coordinates table

This table has been written to a file `/home/andrei/Data/HeteroR/results/repeats_summary_table.csv` and will be used in the Shiny app "repeats_statistic"

```{r, cache=TRUE}
repeat_df <- full_join(bed_df, repeat_df, by="record_id")
repeat_df$spans_center <- if_else(repeat_df$end_1 <= repeat_df$gene_center & repeat_df$start_2 >= repeat_df$gene_center, "yes", "no")

# write it to a file for that Shiny app
write.csv(repeat_df, "/home/andrei/Data/HeteroR/results/repeats_summary_table.csv")

repeat_df
```

# Analysis of repeat pairs

## Sample 40 strains

```{r}
sample_df <- filter(repeat_df, strain %in% strains_sample)

sample_df
```

## Repeat length

```{r, message=F, warning=F, eval = F}
box.rep.len <- plot_ly(data = sample_df,
                  x = ~strain,
                  y = ~length,
                  type = "box",
                  color=~spans_center) %>%
                layout(title="Repeat length",
                   boxmode="group",
                   yaxis=list(type="log"),
                   plot_bgcolor='#e5ecf6',
                   legend=list(title=list(text="Spanning gene's center")))

box.rep.len
```

Boxplot

```{r, warning = F, message = F}
ggbox.rep.len <- ggplot(sample_df, aes(strain, length)) +
  geom_boxplot(aes(fill=spans_center), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle=90)) +
  ggtitle("Repeat length variation") +
  ylab("length") +
  xlab("")

ggbox.rep.len
```

## AR length distribution

```{r, message=F, warning=F, eval=FALSE}
box.ar.len <- plot_ly(data = sample_df,
                      x = ~strain,
                      y = ~AR_length,
                      type = "box",
                      color=~spans_center) %>%
                layout(title="Length of amplifiable region", 
                       boxmode="group",
                       plot_bgcolor='#e5ecf6',
                       legend=list(title=list(text="Spanning gene's center")))

box.ar.len
```

Boxplot

```{r, warning = F, message = F}
ggbox.ar.len <- ggplot(sample_df, aes(strain, AR_length)) +
  geom_boxplot(aes(fill=spans_center), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle=90)) +
  ggtitle("AR length variation") +
  ylab("length") +
  xlab("")

ggbox.ar.len
```

## Repeat count per strain

```{r, message=F, warning=F}
repeat_counts_sample <- sample_df %>% group_by(strain, spans_center) %>% summarise("n_repeats"=n())
repeat_counts_sample
```

```{r, message=F, warning=F, fig.width=12, eval=FALSE}
bar.rep.counts <- plot_ly(data=repeat_counts_sample,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'bar',
                          color= ~spans_center) %>%
  layout(title="Number of repeats",
         boxmode="group",
         plot_bgcolor='#e5ecf6',
         legend=list(title=list(text="Spanning gene's center")))

bar.rep.counts
```

Barplot

```{r, warning = F, message = F, fig.width = 8}
ggbar.rep.counts <- ggplot(repeat_counts_sample, aes(strain, n_repeats)) +
  geom_col(aes(fill=spans_center), position="dodge") + 
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle=90)) +
  ggtitle("Number of found repeats") +
  ylab("n") +
  xlab("")

ggbar.rep.counts
```

## Repeat count around each RG

### Make a table

```{r, message=FALSE, warning=F}

repeat_counts_gene_sample <- sample_df %>% group_by(strain, record_id, spans_center) %>% summarise("n_repeats"=n())

repeat_counts_gene_sample
```

### Make a plot

```{r, message=FALSE, warning=F, fig.width=12, eval=FALSE}
box.rep.counts.gene <- plot_ly(data = repeat_counts_gene_sample,
                      x = ~strain,
                      y = ~n_repeats,
                      type = "box",
                      color= ~spans_center) %>%
  layout(title="Repeat count around RGs",
         yaxis=list(type="log"),
         plot_bgcolor='#e5ecf6',
         boxmode="group",
         legend=list(title=list(text="Spanning gene's center")))

box.rep.counts.gene
```

Boxplot

```{r, warning = F, message = F, fig.width = 8}
ggbox.rep.counts.gene <- ggplot(repeat_counts_gene_sample, aes(strain, n_repeats)) +
  geom_boxplot(aes(fill=spans_center), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle=90)) +
  ggtitle("Number of repeats around RGs") +
  ylab("n") +
  xlab("")

ggbox.rep.counts.gene
```

## All together

```{r, message=F, warning=F, fig.height = 10, fig.width = 14, eval=FALSE}
annotations <- list(
  list(text="Repeat lengths", x=0.2, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="Repeat counts", x=0.8, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="Repeat counts around RGs", x=0.2, y=0.48, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="AR lengths", x=0.8, y=0.48, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE))

subplot(box.rep.len, bar.rep.counts, box.rep.counts.gene, box.ar.len, nrows=2, shareX = T) %>% layout(showlegend=FALSE, annotations=annotations, title="")
```

Plots

```{r,  message=F, warning=F, fig.height = 10, fig.width = 14}

ggarrange(plotlist=list(ggbox.rep.len, ggbox.ar.len, ggbar.rep.counts, ggbox.rep.counts.gene), 
          ncol=2, nrow = 2, 
          align="v", 
          common.legend = T, 
          legend = "bottom")

```

# Analysis of repeat pairs in various AB groups

Here you find repeat statistics broken down by AB groups.

For each strain and gene AB group is defined by RGI's classification of that gene.

The major groups of AB:

-   Penicillins - for example, phenoxymethylpenicillin, flucloxacillin and amoxicillin.
-   Cephalosporins - for example, cefaclor, cefadroxil and cefalexin.
-   Tetracyclines - for example, tetracycline, doxycycline and lymecycline.
-   Aminoglycosides - for example, gentamicin and tobramycin.
-   Macrolides - for example, erythromycin, azithromycin and clarithromycin.
-   Clindamycin.
-   Sulfonamides and trimethoprim - for example, co-trimoxazole.
-   Metronidazole and tinidazole.
-   Quinolones - for example, ciprofloxacin, levofloxacin and norfloxacin.
-   Nitrofurantoin - used for urinary infections.

Let's have a look at 40 strains that I have sampled before

## RGI results table

Remove "Loose" hits

```{r, cache=TRUE}
# sampled strains n=40
#example_strains <- unique(repeat_counts_center2$strain)
#sample_strains <- sample(repeat_df$strain, 40)

# read in RG tables of these strains
rg_df <- bind_rows(lapply(strains_sample, function(x){
  df <- read.delim(paste0("/home/andrei/Data/HeteroR/results/resistance_genes/", x, "/rgi_table.txt"), na.strings = "n/a")
  df$strain <- x
  return(df)
}) )

ab_groups <- unique(rg_df$Drug.Class)

# filter rg_df
rg_df_notLoose <- rg_df %>% 
  filter( Cut_Off != "Loose" ) %>% 
  select(-c(Predicted_Protein, CARD_Protein_Sequence))

rg_df_notLoose
```

Number of rows in the full table `r nrow(rg_df)`, number of rows without "Loose" hits `r nrow(rg_df_notLoose)`

For *Strict* hits you may consider *Identity_percent* as another filtering criterion, hits with too low identities should be discarded.

```{r, message=F}
hit.distr <-ggplot(rg_df %>% filter(Cut_Off == "Strict") %>% select(Best_Identities), aes(Best_Identities)) +
  geom_histogram(bins = 100, fill="steelblue") +
  ggtitle("Distribution of identity percentages among Strict hits")

hit.distr
```


### Filter by Identity percent

Remove hits with less than 70% identity

```{r}
rg_df_notLoose <- rg_df_notLoose %>% 
  filter(Best_Identities >= 70.00)
```

## Number of entries in Drug.Class

Number of unique entries in Drug.Class: `r length(unique(rg_df_notLoose$Drug.Class))`

Unique entries in Drug.CLass

```{r}
unique(rg_df_notLoose$Drug.Class)
```

look at number of repeats around genes conferring resistance to each AB group

## Number of entries per AB group

**NB:** The following table is made with an assumption that entries in *Drug.Class* contain the following names of AB groups:

 - penicillin 
 - cephalosporin
 - tetracycline 
 - aminoglycoside
 - macrolide 
 - clindamycin 
 - sulfonamide 
 - trimethoprim 
 - metronidazole 
 - tinidazole 
 - quinolone 
 - nitrofurantoin

```{r, cache=TRUE}
# "[M,m]etronidazole and [T,t]inidazole"
# "[S,s]ulfonamide[s] and [T,t]rimethoprim"
ab_groups <- c("penicillin", "cephalosporin", "tetracycline", "aminoglycoside", "macrolide", "clindamycin",
               "sulfonamide", "trimethoprim", "metronidazole", "tinidazole", "quinolone", "nitrofurantoin")

ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```

This section must be re-written

```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

## Repeat counts per AB group

Make a table

```{r, cache=TRUE}
# function to add AB labels to each gene in RGI table
# requires vector of AB and RGI results table
# returns a table with TGI and AB joined
add_rgi_to_ab <- function (ab.found, rgi.results){
  rg.ab.found.df <- bind_rows(
    lapply(ab.found, function (x){
    df <- filter(rgi.results, grepl(x, Drug.Class, ignore.case = TRUE)) %>% select(ORF_ID, strain, Drug.Class)
    df$AB.group <- x
    return(df)
    })
  )
  rg.ab.found.df$record_id <- sapply(strsplit(rg.ab.found.df$ORF_ID, " "), function(x){x[1]})
  return(rg.ab.found.df)
}

# function to join RGI results table and repeat counts tibel for each AB found
# requires 3 args: vector of AB found, RGI table, repeat counts table
join_RGI_repeatCounts <- function(rg.ab.found.df, repeat.counts){
  # unify gene names in the repeats table
  repeat.counts$record_id <- sub("_gene", "", repeat.counts$record_id)
  # join repeat counts
  count.per.ab <- left_join(repeat.counts, rg.ab.found.df, by="record_id") %>% filter(!is.na(Drug.Class))
  return(count.per.ab)
}

rg_ab_found_df <- add_rgi_to_ab(ab_found, rg_df_notLoose)
count_per_ab <- join_RGI_repeatCounts(rg_ab_found_df, repeat_counts_gene_sample)
count_per_ab
```

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE, eval=FALSE}
box.rep.n.ab <- plot_ly(data = count_per_ab %>% filter(spans_center == "yes"),
                      x = ~strain.x,
                      y = ~n_repeats,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat counts around resistance genes",
         yaxis=list(type="sqrt", title="repeat count"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')

box.rep.n.ab
```

Boxplot

```{r, warning = F, message = F, fig.width = 12}

ggbox.rep.n.ab <- ggplot(count_per_ab, aes(strain.x, n_repeats)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") + 
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat counts")

ggbox.rep.n.ab
```

## AR length by AB group

On the same sample of strains

Make a table

```{r, cache=TRUE}
# join repeat_df_center (contains AR lengths) and rg_ab_found (contains AB labels for each gene) by record_id
# prepare "record_id" column in repeat_df_center
repeat_df$record_id <- sub("_gene", "", repeat_df$record_id)
# join
repeat_df_center_ab_ar <- left_join(rg_ab_found_df, repeat_df %>% filter(spans_center == "yes"), by="record_id") %>% filter(!is.na(Drug.Class) & !is.na(spans_center))
repeat_df_center_ab_ar
```

Boxplot

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE, eval=FALSE}
box.ar.ab <- plot_ly(data = repeat_df_center_ab_ar,
                      x = ~strain.x,
                      y = ~AR_length,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="AR size variation per AB group",
         yaxis=list(type="sqrt", title="AR length"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')

box.ar.ab
```

```{r, warning = F, message = F, fig.width = 12}
ggbox.ar.ab <- ggplot(repeat_df_center_ab_ar, aes(strain.x, AR_length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  scale_fill_brewer(palette="Set2", name="AB\ngroups") + 
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("AR size variation")

ggbox.ar.ab
```

## Repeat lengths variation by AB group

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE, eval = FALSE}
box.rl.ab <- plot_ly(data = repeat_df_center_ab_ar,
                      x = ~strain.x,
                      y = ~length,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat length variation per AB group",
         yaxis=list(type="log", title="AR length"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')

box.rl.ab

```

Boxplot

```{r, warning = F, message = F, fig.width = 12}
ggbox.rl.ab <- ggplot(repeat_df_center_ab_ar, aes(strain.x, length)) + 
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="log") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") + 
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat size variation")

ggbox.rl.ab
```

## Filter out genes with SNPs

Remove RGs that have SNP as a cause of resistance

```{r, cache=TRUE}
rg_df_notLoose_noSNP <- rg_df_notLoose %>%
  filter(is.na(SNPs_in_Best_Hit_ARO))
```

Number of observations: `r nrow(rg_df_notLoose_noSNP)`

### Number of entries in Drug.Class

```{r}
unique(rg_df_notLoose_noSNP$Drug.Class)
```

### Number of entries per AB group

```{r}
ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose_noSNP, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```

```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

### Repeat counts per AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
rg_ab_found_df <- add_rgi_to_ab(ab_found, rg_df_notLoose_noSNP)
counts_per_ab <- join_RGI_repeatCounts(rg_ab_found_df, repeat_counts_gene_sample)
ggbox.rep.n.ab.noSNP <- ggplot(count_per_ab, aes(strain.x, n_repeats)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat counts", subtitle = "SNPs removed")

ggbox.rep.n.ab.noSNP
```

### AR length by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
#repeat_df$record_id <- sub("_gene", "", repeat_df$record_id)
# join
repeat_df_center_ab_ar <- left_join(rg_ab_found_df, repeat_df %>% filter(spans_center == "yes"), by="record_id") %>% filter(!is.na(Drug.Class) & !is.na(spans_center))

ggbox.ar.ab.noSNP <- ggplot(repeat_df_center_ab_ar, aes(strain.x, AR_length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("AR size variation", subtitle = "SNPs removed")

ggbox.ar.ab.noSNP
```

### Repeat lengths variation by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
ggbox.rl.ab.noSNP <- ggplot(repeat_df_center_ab_ar, aes(strain.x, length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="log") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat size variation", subtitle = "SNPs removed")

ggbox.rl.ab.noSNP
```

## Filter out efflux and AB alteration genes

In RGI results I have the following resistance mechanisms:

```{r}
unique(rg_df_notLoose$Resistance.Mechanism)
```

'efflux' and 'alteration' often go together

I remove all rows in RGI results which contain word *efflux* and *alteration* in Resistance.Mechanism

```{r, cache=TRUE}
rg_df_notLoose_noEfflux <- rg_df_notLoose %>% 
  filter(!grepl("efflux", Resistance.Mechanism)) %>% 
  filter(!grepl("alteration", Resistance.Mechanism))
```

Number of observations: `r nrow(rg_df_notLoose_noEfflux)`

Number of observations with SNPs: `r sum(!is.na(rg_df_notLoose_noEfflux$SNPs_in_Best_Hit_ARO))` (should be 0)

### Number of entries in Drug.Class

```{r}
unique(rg_df_notLoose_noEfflux$Drug.Class)
```

### Number of entries per AB group

```{r}
ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose_noEfflux, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```

```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

### Repeat counts per AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
rg_ab_found_df <- add_rgi_to_ab(ab_found, rg_df_notLoose_noEfflux)
counts_per_ab <- join_RGI_repeatCounts(rg_ab_found_df, repeat_counts_gene_sample)

ggbox.rep.n.ab.noEfflux <- ggplot(count_per_ab, aes(strain.x, n_repeats)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat counts", subtitle = "Efflux and alteration removed")

ggbox.rep.n.ab.noEfflux
```

### AR length by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
#repeat_df$record_id <- sub("_gene", "", repeat_df$record_id)
# join
repeat_df_center_ab_ar <- left_join(rg_ab_found_df, repeat_df %>% 
                                      filter(spans_center == "yes"), by="record_id") %>% 
  filter(!is.na(Drug.Class) & !is.na(spans_center))

ggbox.ar.ab.noEfflux <- ggplot(repeat_df_center_ab_ar, aes(strain.x, AR_length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("AR size variation", subtitle = "Efflux and alteration removed")

ggbox.ar.ab.noEfflux
```

### Repeat lengths variation by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
ggbox.rl.ab.noEfflux <- ggplot(repeat_df_center_ab_ar, aes(strain.x, length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="log") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat size variation", subtitle = "Efflux and alteration removed")

ggbox.rl.ab.noEfflux
```


## Only AB modification

Leave only observations with *target inactivation* as resistance mechanism

```{r, cache=TRUE}
rg_df_notLoose_Tinact <- rg_df_notLoose %>% 
  filter(grepl("inactivation", Resistance.Mechanism))
```

Number of observations: `r nrow(rg_df_notLoose_Tinact)`

### Number of entries in  Drug.Class

```{r}
unique(rg_df_notLoose_Tinact$Drug.Class)
```

### Number of entries per AB group

```{r}
ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose_Tinact, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```

```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

### Repeat counts per AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
rg_ab_found_df <- add_rgi_to_ab(ab_found, rg_df_notLoose_Tinact)
counts_per_ab <- join_RGI_repeatCounts(rg_ab_found_df, repeat_counts_gene_sample)

ggbox.rep.n.ab.Tinact <- ggplot(count_per_ab, aes(strain.x, n_repeats)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="sqrt") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat counts", subtitle = "Only 'AB inactivation'")

ggbox.rep.n.ab.Tinact
```

### AR length by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
#repeat_df$record_id <- sub("_gene", "", repeat_df$record_id)
# join
repeat_df_center_ab_ar <- left_join(rg_ab_found_df, repeat_df %>% 
                                      filter(spans_center == "yes"), by="record_id") %>% 
  filter(!is.na(Drug.Class) & !is.na(spans_center))

ggbox.ar.ab.Tinact <- ggplot(repeat_df_center_ab_ar, aes(strain.x, AR_length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("AR size variation", subtitle =  "Only 'AB inactivation'")

ggbox.ar.ab.Tinact
```

### Repeat lengths variation by AB group

```{r, cache=TRUE, warning = F, message = F, fig.width = 12}
ggbox.rl.ab.Tinact <- ggplot(repeat_df_center_ab_ar, aes(strain.x, length)) +
  geom_boxplot(aes(fill=AB.group), outlier.alpha = 0.5, outlier.size = 0.5)+
  coord_trans(y="log") +
  scale_fill_brewer(palette="Set2", name="AB\ngroups") +
  theme(axis.text.x = element_text(angle=90), legend.position = "top")+
  xlab("") +
  ylab("n") +
  ggtitle("Repeat size variation", subtitle =  "Only 'AB inactivation'")

ggbox.rl.ab.Tinact
```

## NB

This sections might not be of a big value since we have Resistance/Susceptibility testing results in a separate data frame.

# Analysis of resistant and susceptible strains

I have some (preliminary) resistance/susceptibility information for 400+ strains in `resources/resistance_testing.csv` (taken from Resilio storage).

## Get the data

```{r, cache=TRUE}
resistance_df <- read.csv("/home/andrei/Data/HeteroR/resources/resistance_testing.csv", na.strings = "", stringsAsFactors = T)
resistance_df <- select(resistance_df, contains("SIR") | contains("strain"))
names(resistance_df) <- sub(".SIR", "", names(resistance_df))
resistance_df
```

Columns with *SIR* contain susceptibility test results, S - susceptible, R - resistant, I - intermediate.

------------------------------------------------------------------------

CFX - Cefotaxime, Beta-lactam group

TZP - Pip-Taz

GM - Gentamicin, Aminoglycoside family

AMP - Ampicillin, Penicillin family, Aminopenicillin group

TBM - Tobramycin

TMP - Trimethoprim

NFT - Nitrofurantoin

MCN - Mecillinam

------------------------------------------------------------------------

### Data overview

```{r}
summary(resistance_df)
```

N.B.: Number of resistant strains is smaller than number of susceptible ones.

### Make a tidy version

```{r, message=FALSE, warning=FALSE, cache=TRUE}
resistance_df_td <- gather(resistance_df, key="AB", value="condition", 1:8)
resistance_df_td$AB <- as.factor(resistance_df_td$AB)
resistance_df_td$condition <- factor(resistance_df_td$condition, ordered=T, levels = c("S", "I", "R"))

# for plotly
condition_numeric <- sub("S", 0, resistance_df_td$condition)
condition_numeric <- sub("I", 1, condition_numeric)
condition_numeric <- sub("R", 2, condition_numeric)

resistance_df_td$condition_num <- as.integer(condition_numeric)

resistance_df_td
```

## Resistance heatmap

### Entire table

```{r, fig.width=14, fig.height=6, warning=F, nessage=F}
htmp_res_all <- ggplot(resistance_df_td, aes(strain, AB)) +
  geom_tile(aes(fill=condition)) +
  theme(axis.text.x = element_text(angle=45, size=4, vjust=0.5))

# plotly version
hm_res_all <- plot_ly(data = resistance_df_td,
                            x = ~ strain,
                            y = ~ AB,
                            z = ~ condition_num,
                            type = "heatmap") %>% 
    layout(title="Resistance testing results") %>% colorbar(title="Resistance level")

hm_res_all
```

### Sample subset

```{r}
res_df_sample <- filter(resistance_df_td, strain %in% strains_sample)
res_df_sample
```

```{r, fig.width=8, warning=F, nessage=F}
htmp_res_sample <- ggplot(res_df_sample, aes(strain, AB)) +
  geom_tile(aes(fill=condition)) +
  theme(axis.text.x = element_text(angle=45, vjust=0.5))

# plotly version
hm_res_sample <- plot_ly(data = res_df_sample,
                            x = ~ strain,
                            y = ~ AB,
                            z = ~ condition_num,
                            type = "heatmap") %>% 
    layout(title="Resistance testing results") %>% colorbar(title="Resistance level")

hm_res_sample
```

## Repeat number, length, AR length differences between R and S strains

I have genes conferring resistance to Gentamicin (GM) - *Aminoglycoside antibiotic* in the RGI results table.

Also, I have resistant and susceptible strains to GM in my collection - see the heatmaps above

Let's explore differences between R and S

I exclude I-strains since there's too few of them

...

### Prepare the data

```{r, cache=TRUE}
ab_res_repeat_df <- inner_join(resistance_df_td, repeat_df, by="strain") %>%
  filter(!is.na(condition)) %>%
  filter(condition != "I")

ab_res_repeat_df
```

### Repeat length

```{r, warning = F, message = F, fig.width = 14, fig.height = 6, eval=FALSE}

box.rl.res.y <- plot_ly(data = ab_res_repeat_df %>% filter(spans_center == "yes"),
                      x = ~AB,
                      y = ~length,
                      color = ~condition,
                      colors = c("#66C2A5", "#FC8D62"),  # taken from Set2
                      type = "box") %>%
                  layout(title="Lengths of repeats spanning region's center in resistant and susceptible strains",
                         yaxis=list(type="log", title="Repeat length"),
                         boxmode="group",
                         xaxis=list(title=""),
                         plot_bgcolor='#e5ecf6')

box.rl.res.n <- plot_ly(data = ab_res_repeat_df %>% filter(spans_center == "no"),
                      x = ~AB,
                      y = ~length,
                      color = ~condition,
                      colors = c("#66C2A5", "#FC8D62"),  # taken from Set2
                      type = "box") %>%
                  layout(title="Lengths of repeats not spanning region's center in resistant and susceptible strains",
                         yaxis=list(type="log", title="Repeat length"),
                         boxmode="group",
                         xaxis=list(title=""),
                         plot_bgcolor='#e5ecf6')

annotations <- list(
  list(text="Spanning center", x=0.2, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="Not spanning center", x=0.85, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE))

subplot(box.rl.res.y, box.rl.res.n, nrows=1, shareX = T, shareY = T) %>% layout(showlegend=FALSE, annotations=annotations, title="Repeat lengths")

```

#### All repeats

Including repeat pairs both spanning ("yes") and not spanning ("no") corresponding gene's center

```{r, fig.width = 10, fig.height = 5}
ggbox.rl.ab <- ggplot(ab_res_repeat_df, aes(AB , length)) +
  geom_boxplot(aes(fill=condition), notch=T, outlier.size = 0.5, outlier.alpha = 0.5) +
  coord_trans(y="log") +
  facet_grid(spans_center ~ .) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Repeat length")+
  ylab("length") +
  xlab("antibiotic")

ggbox.rl.ab
```

#### Repeats longer 100 bp

```{r, fig.width = 10, fig.height = 5}
ggbox.rl.ab.100 <- ggplot(ab_res_repeat_df %>% filter(length >= 100), aes(AB , length)) +
  geom_boxplot(aes(fill=condition), notch=F, outlier.size = 0.5, outlier.alpha = 0.5) +
  coord_trans(y="log") +
  facet_grid(spans_center ~ .) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Repeat length", subtitle="Repeats longer than 100 bp only")+
  ylab("length") +
  xlab("antibiotic")

ggbox.rl.ab.100
```

### AR length

Including repeat pairs both spanning ("yes") and not spanning ("no") corresponding gene's center

#### All

```{r, fig.width = 10, fig.height = 5}
ggbox.arlen.res <- ggplot(ab_res_repeat_df, aes(AB , AR_length)) +
  geom_boxplot(aes(fill=condition), notch=T, outlier.size = 0.5, outlier.alpha = 0.5) +
  coord_trans(y="sqrt") +
  facet_grid(spans_center ~ .) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Amplifiable region length") +
  ylab("length") +
  xlab("antibiotic")

ggbox.arlen.res
```

#### For repeats longer than 100 bp

```{r, fig.width = 10, fig.height = 5, message=FALSE, warning=FALSE}
ggbox.arlen.res.100 <- ggplot(ab_res_repeat_df %>% filter(length >= 100), aes(AB , AR_length)) +
  geom_boxplot(aes(fill=condition), notch=T, outlier.size = 0.5, outlier.alpha = 0.5) +
  coord_trans(y="sqrt") +
  facet_grid(spans_center ~ .) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle(label="Amplifiable region length", subtitle="For repeats longer than 100 bp") +
  ylab("length") +
  xlab("antibiotic")

ggbox.arlen.res.100
```

### Repeat count

Including repeat pairs both spanning ("yes") and not spanning ("no") corresponding gene's center.

Prepare data

```{r, message=FALSE, cache=TRUE}
ab_res_rep_count <- ab_res_repeat_df %>%
  group_by(AB, condition, strain, spans_center) %>%
  summarize(n=n()) %>%
  filter(condition != "I")

ab_res_rep_count
```

#### All

Boxplot

```{r, warning = F, message = F, fig.width = 10, fig.height = 5}
ggbox.rc.res <- ggplot(ab_res_rep_count, aes(AB, n)) +
        geom_boxplot(aes(fill = condition), notch=F) +
        coord_trans(y="sqrt") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat count") 

ggbox.rc.res
```

#### Repeats longer than 100 bp

Prepare the data

```{r, message = F, cache = T}
ab_res_rep_count.100 <- ab_res_repeat_df %>%
        filter(length >= 100) %>%
        group_by(AB, condition, strain, spans_center) %>%
        summarize(n=n()) %>%
        filter(condition != "I")

ab_res_rep_count.100
```

Boxplot

```{r, message=F, warning = F, fig.width = 10, fig.height = 5}
ggbox.rc.res.100 <- ggplot(ab_res_rep_count.100, aes(AB, n)) +
        geom_boxplot(aes(fill = condition), notch=F) +
        coord_trans(y="sqrt") +
        facet_grid(spans_center ~ .) +
        scale_fill_brewer(palette = "Set2") +
        ggtitle(label="Repeat count", subtitle="Repeats longer than 100 bp only")

ggbox.rc.res.100
```

# Save workspace

```{r}
save.image(f="/home/andrei/Data/HeteroR/notebooks/repeats_summary.RData")
```
