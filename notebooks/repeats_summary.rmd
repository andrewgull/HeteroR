---
title: "Repeat Summary"
author: "AG"
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    rmdformats:
      theme: readthedown
      highlight: github
---

This notebook relies on results from *make_repeat_tables.py* that creates tables which contain
coordinates of repeat for each strain and each resistance gene

# Summary repeat table

```{r, message = FALSE, warning = FALSE}
# a new way of getting repeat data frame across all strains
# on linux desktop load("/home/andrei/Data/HeteroR/.RDataFiles/725233088.RData")
library(dplyr)
strains <- dir("/home/andrei/Data/HeteroR/results/direct_repeats")
repeat_csv_paths <- sapply(strains, function(x){paste0("/home/andrei/Data/HeteroR/results/annotations/",x ,"/repeats/", x, "_repeats.csv")})

repeat_df <- bind_rows(lapply(repeat_csv_paths, function(x){read.csv(x)}))
repeat_df
```

Number of rows: `r nrow(repeat_df)`

Number of strains: `r length(unique(repeat_df$strain))`

## Filter duplicates

There is no identical coordinate pairs (if you consider gene name as well)

```{r}
repeat_df_dedup <- repeat_df %>% distinct(record_id, start_1, end_1, start_2, end_2, .keep_all = TRUE)

```

Number of rows: `r nrow(repeat_df_dedup)`

Number of strains: `r length(unique(repeat_df_dedup$strain))`

# Sample 40 strains

To see fully interactive plots, go check `shiny_apps`

```{r}
library(dplyr)

set.seed(99)
strains <- unique(repeat_df$strain)
strains_sample <- sample(strains, 40, replace = FALSE)
sample_df <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df, strain == x)
        })
)

sample_df
```


## Repeat lengths distribution

```{r, message=FALSE, warning=FALSE, fig.width=12}
library(plotly)

box.rep.len <- plot_ly(data = sample_df, 
                       x = ~strain, 
                       y = ~length,
                       type = "box") %>%  
  layout(yaxis = list(type="log"),
         title="Repeat lengths",
         plot_bgcolor='#e5ecf6')

box.rep.len
```

```{r, eval=FALSE}
# sliders
sample.size <- list(

  list(args = list("marker.color", "red"), 

                    label = "Red", 

                    method = "restyle", 

                    value = "1"

                    ),

  list(args = list("marker.color", "green"), 

                    label = "Green", 

                    method = "restyle", 

                    value = "2"

                    ),

  list(args = list("marker.color", "blue"), 

                    label = "Blue", 

                    method = "restyle", 

                    value = "3"

                    )

  )


box.rep.len %>% layout(sliders = list())
```


## Repeat count per strain

```{r, message=FALSE, warning=FALSE}
repeat_counts <- sample_df %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r, fig.width=12}
bar.rep.counts <- plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'bar') %>% 
  layout(title="Number of repeats per strain",
         plot_bgcolor='#e5ecf6')

bar.rep.counts
```

## Repeat count around each RG

```{r, message=FALSE, warning=FALSE}
repeat_counts <- sample_df %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r, fig.width=12}
box.rep.counts.rg <- plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'box')

# violin plots have misleading KDE below zero
viol.rep.counts.rg <-  plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'violin',
                          box = list(visible = T),
                          meanline = list(visible = T))

box.rep.counts.rg %>% layout(yaxis = list(type="log"), title="Repeat counts around resistance genes", plot_bgcolor='#e5ecf6')
```

## Distances between repeat pairs aka "AR length"

```{r}
repeat_df$AR_length <- repeat_df$start_2 - repeat_df$end_1
sample_df$AR_length <- sample_df$start_2 - sample_df$end_1

```


```{r, fig.width=12}
box.ar.len <- plot_ly(data = sample_df,
                      x = ~strain,
                      y = ~AR_length,
                      type = "box") %>%
  layout(title="Length of amplifiable region",
         plot_bgcolor='#e5ecf6')

# violin plots have misleading KDE below zero
viol.ar.len <-  plot_ly(data=sample_df,
                          x = ~strain,
                          y = ~AR_length,
                          type = 'violin',
                          box = list(visible = T),
                          meanline = list(visible = T))

box.ar.len
```



# Filter out repeats not spanning the center of every range

The middle of the range is the middle of the RG
Those repeats that are located on the same side of it, are not interesting for us because they don't affect amplifications rate

To get repeat coordinates I need bed files: regions_within.bed

The files are here:

`results/direct_repeats/DA*/regions/regions_within.bed`

```{r}
bed_df <- bind_rows(lapply(strains, function (x){
  filename <- paste0("/home/andrei/Data/HeteroR/results/direct_repeats/", x, "/regions/regions_within.bed")
  df <- read.delim(filename, header=FALSE)
  return(df)
}))

bed_df$gene_center <- round((bed_df$V3 - bed_df$V2 + 1)/2)
bed_df <- rename(bed_df, "record_id"=V4)
bed_df <- select(bed_df, record_id, gene_center)

bed_df
```

Number of gene names: `r length(unique(bed_df$record_id))`

Number of rows: `r nrow(bed_df)`

Number of unique gene names equals number of rows in bed_df, which means I can join bed and repeats tables using gene names only

## Joined repeat summary table and coordinates table

This table has been written to a file `/home/andrei/Data/HeteroR/results/repeats_summary_table.csv` and will be used in the Shiny app "repeats_statistic"

```{r}
repeat_df <- full_join(bed_df, repeat_df, by="record_id")
repeat_df$spans_center <- if_else(repeat_df$end_1 <= repeat_df$gene_center & repeat_df$start_2 >= repeat_df$gene_center, "yes", "no")

# write it to a file for that Shiny app
write.csv(repeat_df, "/home/andrei/Data/HeteroR/results/repeats_summary_table.csv")

repeat_df
```

## Filter out repeat pairs that don't span region's center

```{r}
repeat_df_center <- repeat_df %>% filter(spans_center == "yes")
repeat_df_center
```

Number of strains: `r length(unique(repeat_df_center$strain))`, i.e. all strains have at least one repeat pair spanning gene center.

# Analysis of repeat pairs spanning region center

## Sample 40 strains

```{r}
sample_df_center <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df_center, strain == x)
        })
)

sample_df_center
```

## Repeat length

```{r, fig.width=12}
box.rep.len.c <- plot_ly(data = sample_df_center,
                      x = ~strain,
                      y = ~length,
                      type = "box") %>%
  layout(title="Repeat length",
         yaxis=list(type="log"),
         plot_bgcolor='#e5ecf6')

box.rep.len.c
```


## Repeat count per strain

```{r}
repeat_counts_center <- sample_df_center %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts_center
```

```{r, fig.width=12}
bar.rep.counts.c <- plot_ly(data=repeat_counts_center,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'bar') %>% 
  layout(title="Number of repeats",
         plot_bgcolor='#e5ecf6')

bar.rep.counts.c
```


## Repeat count around each RG

```{r, message=FALSE, warning=F, fig.width=12}

repeat_counts_center2 <- sample_df_center %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())

box.rep.count.c <- plot_ly(data = repeat_counts_center2,
                      x = ~strain,
                      y = ~n_repeats,
                      type = "box") %>%
  layout(title="Repeat count around RGs",
         yaxis=list(type="log"),
         plot_bgcolor='#e5ecf6')

box.rep.count.c
```


## AR length distribution

```{r, fig.width=12}
box.ar.len.c <- plot_ly(data = sample_df_center,
                      x = ~strain,
                      y = ~AR_length,
                      type = "box") %>% layout(title="Length of amplifiable region", plot_bgcolor='#e5ecf6')
box.ar.len.c
```


# Number of repeats per AB group

Take AB classes from rgi tables?
Or from known AB classes?
Or group AB by mechanisms?

## Main groups of AB

 - Penicillins - for example, phenoxymethylpenicillin, flucloxacillin and amoxicillin.
 - Cephalosporins - for example, cefaclor, cefadroxil and cefalexin.
 - Tetracyclines - for example, tetracycline, doxycycline and lymecycline.
 - Aminoglycosides - for example, gentamicin and tobramycin.
 - Macrolides - for example, erythromycin, azithromycin and clarithromycin.
 - Clindamycin.
 - Sulfonamides and trimethoprim - for example, co-trimoxazole.
 - Metronidazole and tinidazole.
 - Quinolones - for example, ciprofloxacin, levofloxacin and norfloxacin.
 - Nitrofurantoin - used for urinary infections.

Let's have a look at 40 strains that I have sampled before

## Resistance Gene Identifier results table: sample of stains

```{r}
# sampled strains n=40
#example_strains <- unique(repeat_counts_center2$strain)
#sample_strains <- sample(repeat_df$strain, 40)

# read in RG tables of these strains
rg_df <- bind_rows(lapply(strains_sample, function(x){
  df <- read.delim(paste0("/home/andrei/Data/HeteroR/results/resistance_genes/", x, "/rgi_table.txt"))
  df$strain <- x
  return(df)
}) )

ab_groups <- unique(rg_df$Drug.Class)

rg_df
```

Number of rows `r nrow(rg_df)`

### Resistance Gene Identifier results table - filter out 'Loose' hits

```{r}
rg_df_notLoose <- rg_df %>% filter( Cut_Off != "Loose")
```

Number of rows `r nrow(rg_df_notLoose)`

Still some left...

## Number of entries in Drug.Class

Number of entries in Drug.Class: `r length(unique(rg_df_notLoose$Drug.Class))`

```{r}
unique(rg_df_notLoose$Drug.Class)
```

look at number of repeats around genes conferring resistance to each AB group

## Number of entries per AB group

```{r}
# "[M,m]etronidazole and [T,t]inidazole"
# "[S,s]ulfonamide[s] and [T,t]rimethoprim"
ab_groups <- c("penicillin", "cephalosporin", "tetracycline", "aminoglycoside", "macrolide", "clindamycin", "sulfonamide", "trimethoprim", "metronidazole", "tinidazole", "quinolone", "nitrofurantoin")

ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```


```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

## Repeat counts per AB group

```{r}
rg_ab_found_df <- bind_rows(
  lapply(ab_found, function (x){
  df <- filter(rg_df_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% select(ORF_ID, strain, Drug.Class)
  df$AB.group <- x
  return(df)
  })
)

# unify gene names in the repeats table
repeat_counts_center2$record_id <- sub("_gene", "", repeat_counts_center2$record_id)
rg_ab_found_df$record_id <- sapply(strsplit(rg_ab_found_df$ORF_ID, " "), function(x){x[1]})

# join repeat counts
count_per_ab <- left_join(repeat_counts_center2, rg_ab_found_df, by="record_id") %>% filter(!is.na(Drug.Class))
count_per_ab
```

Boxplot

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE}
box.rep.n.ab <- plot_ly(data = count_per_ab,
                      x = ~strain.x,
                      y = ~n_repeats,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat counts around resistance genes",
         yaxis=list(type="sqrt", title="repeat count"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')
box.rep.n.ab
```

## Plot all strains

### Make a table

```{r}

# read in RG tables of all strains
rg_df_all <- bind_rows(lapply(strains, function(x){
  df <- read.delim(paste0("/home/andrei/Data/HeteroR/results/resistance_genes/", x, "/rgi_table.txt"))
  df$strain <- x
  return(df)
}) )

ab_groups_all <- unique(rg_df_all$Drug.Class)

rg_df_all_notLoose <- rg_df_all %>% filter( Cut_Off != "Loose")


# "[M,m]etronidazole and [T,t]inidazole"
# "[S,s]ulfonamide[s] and [T,t]rimethoprim"
ab_groups <- c("penicillin", "cephalosporin", "tetracycline", "aminoglycoside", "macrolide", "clindamycin", "sulfonamide", "trimethoprim", "metronidazole", "tinidazole", "quinolone", "nitrofurantoin")

ab_counts_vec_all <- sapply(ab_groups, function (x){
  filter(rg_df_all_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df_all <- data.frame("count" = ab_counts_vec_all, "AB.group" = names(ab_counts_vec_all))
rownames(ab_counts_df_all) <- NULL

ab_found_all <- names(ab_counts_vec_all[ab_counts_vec_all != 0])

rg_ab_found_df_all <- bind_rows(
  lapply(ab_found_all, function (x){
  df <- filter(rg_df_all_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% select(ORF_ID, strain, Drug.Class)
  df$AB.group <- x
  return(df)
  })
)

# reepat counts for all strains
repeat_counts_center_all <- repeat_df_center %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())

# unify gene names in the repeats table
repeat_counts_center_all$record_id <- sub("_gene", "", repeat_counts_center_all$record_id)
rg_ab_found_df_all$record_id <- sapply(strsplit(rg_ab_found_df_all$ORF_ID, " "), function(x){x[1]})

# join repeat counts
count_per_ab_all <- left_join(repeat_counts_center_all, rg_ab_found_df_all, by="record_id") %>% filter(!is.na(Drug.Class))
count_per_ab_all
```

Overall numer of entries in Drug.Class `r length(unique(rg_df_all_notLoose$Drug.Class))`


### Plot

```{r, fig.width=20, fig.height = 8, message = FALSE, warning = FALSE}
box.rep.n.ab.all <- plot_ly(data = count_per_ab_all,
                      x = ~strain.x,
                      y = ~n_repeats,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat counts around resistance genes",
         yaxis=list(type="sqrt", title="repeat count"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')
box.rep.n.ab.all
```
