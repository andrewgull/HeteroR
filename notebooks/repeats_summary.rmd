---
title: "Repeat Summary"
author: "AG"
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    rmdformats:
      theme: readthedown
      highlight: github
---

This notebook relies on results from *make_repeat_tables.py* that creates tables which contain
coordinates of repeat for each strain and each resistance gene

# Summary repeat table

```{r, message = FALSE, warning = FALSE}
# a new way of getting repeat data frame across all strains
# on linux desktop load("/home/andrei/Data/HeteroR/.RDataFiles/725233088.RData")
library(dplyr)
library(tidyr)
strains <- dir("/home/andrei/Data/HeteroR/results/direct_repeats")
repeat_csv_paths <- sapply(strains, function(x){paste0("/home/andrei/Data/HeteroR/results/annotations/",x ,"/repeats/", x, "_repeats.csv")})

repeat_df <- bind_rows(lapply(repeat_csv_paths, function(x){read.csv(x)}))
repeat_df
```

Number of rows: `r nrow(repeat_df)`

Number of strains: `r length(unique(repeat_df$strain))`

## Filter duplicates

There is no identical coordinate pairs (if you consider gene name as well)

```{r}
repeat_df_dedup <- repeat_df %>% distinct(record_id, start_1, end_1, start_2, end_2, .keep_all = TRUE)

```

Number of rows: `r nrow(repeat_df_dedup)`

Number of strains: `r length(unique(repeat_df_dedup$strain))`

# Sample 40 strains

To see fully interactive plots, go check `shiny_apps`

```{r}
library(dplyr)

set.seed(99)
strains <- unique(repeat_df$strain)
strains_sample <- sample(strains, 40, replace = FALSE)
sample_df <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df, strain == x)
        })
)

sample_df
```


## Repeat lengths distribution

```{r, message=FALSE, warning=FALSE, fig.width=12}
library(plotly)

box.rep.len <- plot_ly(data = sample_df, 
                       x = ~strain, 
                       y = ~length,
                       type = "box") %>%  
  layout(yaxis = list(type="log"),
         title="Repeat lengths",
         plot_bgcolor='#e5ecf6')

box.rep.len
```

```{r, eval=FALSE}
# sliders
sample.size <- list(

  list(args = list("marker.color", "red"), 

                    label = "Red", 

                    method = "restyle", 

                    value = "1"

                    ),

  list(args = list("marker.color", "green"), 

                    label = "Green", 

                    method = "restyle", 

                    value = "2"

                    ),

  list(args = list("marker.color", "blue"), 

                    label = "Blue", 

                    method = "restyle", 

                    value = "3"

                    )

  )


box.rep.len %>% layout(sliders = list())
```


## Repeat count per strain

```{r, message=FALSE, warning=FALSE}
repeat_counts <- sample_df %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r, fig.width=12}
bar.rep.counts <- plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'bar') %>% 
  layout(title="Number of repeats per strain",
         plot_bgcolor='#e5ecf6')

bar.rep.counts
```

## Repeat count around each RG

```{r, message=FALSE, warning=FALSE}
repeat_counts <- sample_df %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())
repeat_counts
```

```{r, fig.width=12}
box.rep.counts.rg <- plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'box')

# violin plots have misleading KDE below zero
viol.rep.counts.rg <-  plot_ly(data=repeat_counts,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'violin',
                          box = list(visible = T),
                          meanline = list(visible = T))

box.rep.counts.rg %>% layout(yaxis = list(type="log"), title="Repeat counts around resistance genes", plot_bgcolor='#e5ecf6')
```

## Distances between repeat pairs aka "AR length"

```{r}
repeat_df$AR_length <- repeat_df$start_2 - repeat_df$end_1
sample_df$AR_length <- sample_df$start_2 - sample_df$end_1

```


```{r, fig.width=12}
box.ar.len <- plot_ly(data = sample_df,
                      x = ~strain,
                      y = ~AR_length,
                      type = "box") %>%
  layout(title="Length of amplifiable region",
         plot_bgcolor='#e5ecf6')

# violin plots have misleading KDE below zero
viol.ar.len <-  plot_ly(data=sample_df,
                          x = ~strain,
                          y = ~AR_length,
                          type = 'violin',
                          box = list(visible = T),
                          meanline = list(visible = T))

box.ar.len
```



# Filter out repeats not spanning the center of every range

The middle of the range is the middle of the RG
Those repeats that are located on the same side of it, are not interesting for us because they don't affect amplifications rate

To get repeat coordinates I need bed files: regions_within.bed

The files are here:

`results/direct_repeats/DA*/regions/regions_within.bed`

```{r}
bed_df <- bind_rows(lapply(strains, function (x){
  filename <- paste0("/home/andrei/Data/HeteroR/results/direct_repeats/", x, "/regions/regions_within.bed")
  df <- read.delim(filename, header=FALSE)
  return(df)
}))

bed_df$gene_center <- round((bed_df$V3 - bed_df$V2 + 1)/2)
bed_df <- rename(bed_df, "record_id"=V4)
bed_df <- select(bed_df, record_id, gene_center)

bed_df
```

Number of gene names: `r length(unique(bed_df$record_id))`

Number of rows: `r nrow(bed_df)`

Number of unique gene names equals number of rows in bed_df, which means I can join bed and repeats tables using gene names only

## Joined repeat summary table and coordinates table

This table has been written to a file `/home/andrei/Data/HeteroR/results/repeats_summary_table.csv` and will be used in the Shiny app "repeats_statistic"

```{r}
repeat_df <- full_join(bed_df, repeat_df, by="record_id")
repeat_df$spans_center <- if_else(repeat_df$end_1 <= repeat_df$gene_center & repeat_df$start_2 >= repeat_df$gene_center, "yes", "no")

# write it to a file for that Shiny app
write.csv(repeat_df, "/home/andrei/Data/HeteroR/results/repeats_summary_table.csv")

repeat_df
```

## Filter out repeat pairs that don't span region's center

```{r}
repeat_df_center <- repeat_df %>% filter(spans_center == "yes")
repeat_df_center
```

Number of strains: `r length(unique(repeat_df_center$strain))`, i.e. all strains have at least one repeat pair spanning gene center.

# Analysis of repeat pairs spanning region center

## Sample 40 strains

```{r}
sample_df_center <- bind_rows(
        lapply(strains_sample, function(x){
          filter(repeat_df_center, strain == x)
        })
)

sample_df_center
```

## Repeat length

```{r, fig.width=12}
box.rep.len.c <- plot_ly(data = sample_df_center,
                      x = ~strain,
                      y = ~length,
                      type = "box",
                      color=I("#0B5394")) %>%
  layout(title="Repeat length",
         yaxis=list(type="log"),
         plot_bgcolor='#e5ecf6')

box.rep.len.c
```


## Repeat count per strain

```{r}
repeat_counts_center <- sample_df_center %>% group_by(strain) %>% summarise("n_repeats"=n())
repeat_counts_center
```

```{r, fig.width=12}
bar.rep.counts.c <- plot_ly(data=repeat_counts_center,
                          x = ~strain,
                          y = ~n_repeats,
                          type = 'bar',
                          color=I("#0B5394")) %>%
  layout(title="Number of repeats",
         plot_bgcolor='#e5ecf6')

bar.rep.counts.c
```


## Repeat count around each RG

```{r, message=FALSE, warning=F, fig.width=12}

repeat_counts_center2 <- sample_df_center %>% group_by(record_id, strain) %>% summarise("n_repeats"=n())

box.rep.count.c <- plot_ly(data = repeat_counts_center2,
                      x = ~strain,
                      y = ~n_repeats,
                      type = "box",
                      color=I("#0B5394")) %>%
  layout(title="Repeat count around RGs",
         yaxis=list(type="log"),
         plot_bgcolor='#e5ecf6')

box.rep.count.c
```


## AR length distribution

```{r, fig.width=12}
box.ar.len.c <- plot_ly(data = sample_df_center,
                      x = ~strain,
                      y = ~AR_length,
                      type = "box",
                      color=I("#0B5394")) %>%
  layout(title="Length of amplifiable region", plot_bgcolor='#e5ecf6')

box.ar.len.c
```

## All together

```{r, fig.height = 10, fig.width = 14}
annotations <- list(
  list(text="Repeat lengths", x=0.2, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="Repeat counts", x=0.8, y=1.0, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="Repeat counts around RGs", x=0.2, y=0.48, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE),
  list(text="AR lengths", x=0.8, y=0.48, xref = "paper", yref = "paper", xanchor = "center", yanchor = "bottom", showarrow = FALSE))

subplot(box.rep.len.c, bar.rep.counts.c, box.rep.count.c, box.ar.len.c, nrows=2, shareX = T) %>% layout(showlegend=FALSE, annotations=annotations, title="")
```

# Statistics by main groups of AB

 - Penicillins - for example, phenoxymethylpenicillin, flucloxacillin and amoxicillin.
 - Cephalosporins - for example, cefaclor, cefadroxil and cefalexin.
 - Tetracyclines - for example, tetracycline, doxycycline and lymecycline.
 - Aminoglycosides - for example, gentamicin and tobramycin.
 - Macrolides - for example, erythromycin, azithromycin and clarithromycin.
 - Clindamycin.
 - Sulfonamides and trimethoprim - for example, co-trimoxazole.
 - Metronidazole and tinidazole.
 - Quinolones - for example, ciprofloxacin, levofloxacin and norfloxacin.
 - Nitrofurantoin - used for urinary infections.

Let's have a look at 40 strains that I have sampled before

## Number of repeats per AB group

Take AB classes from rgi tables?
Or from known AB classes?
Or group AB by mechanisms?

## RGI results table

Remove "Loose" hits

```{r}
# sampled strains n=40
#example_strains <- unique(repeat_counts_center2$strain)
#sample_strains <- sample(repeat_df$strain, 40)

# read in RG tables of these strains
rg_df <- bind_rows(lapply(strains_sample, function(x){
  df <- read.delim(paste0("/home/andrei/Data/HeteroR/results/resistance_genes/", x, "/rgi_table.txt"))
  df$strain <- x
  return(df)
}) )

ab_groups <- unique(rg_df$Drug.Class)

rg_df_notLoose <- rg_df %>% filter( Cut_Off != "Loose")
rg_df_notLoose
```

Number of rows in the full table `r nrow(rg_df)`, number of rows without "Loose" hits `r nrow(rg_df_notLoose)`

## Number of entries in Drug.Class

Number of unique entries in Drug.Class: `r length(unique(rg_df_notLoose$Drug.Class))`

Unique entries in Drug.CLass

```{r}
unique(rg_df_notLoose$Drug.Class)
```

look at number of repeats around genes conferring resistance to each AB group

## Number of entries per AB group

```{r}
# "[M,m]etronidazole and [T,t]inidazole"
# "[S,s]ulfonamide[s] and [T,t]rimethoprim"
ab_groups <- c("penicillin", "cephalosporin", "tetracycline", "aminoglycoside", "macrolide", "clindamycin",
               "sulfonamide", "trimethoprim", "metronidazole", "tinidazole", "quinolone", "nitrofurantoin")

ab_counts_vec <- sapply(ab_groups, function (x){
  filter(rg_df_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% nrow()
})

ab_counts_df <- data.frame("count" = ab_counts_vec, "AB.group" = names(ab_counts_vec))
rownames(ab_counts_df) <- NULL

ab_counts_df
```


```{r}
ab_found <- names(ab_counts_vec[ab_counts_vec != 0])
```

## Repeat counts per AB group

```{r}
# add AB labels to each gene in RGI table
rg_ab_found_df <- bind_rows(
  lapply(ab_found, function (x){
  df <- filter(rg_df_notLoose, grepl(x, Drug.Class, ignore.case = TRUE)) %>% select(ORF_ID, strain, Drug.Class)
  df$AB.group <- x
  return(df)
  })
)

# unify gene names in the repeats table
repeat_counts_center2$record_id <- sub("_gene", "", repeat_counts_center2$record_id)
rg_ab_found_df$record_id <- sapply(strsplit(rg_ab_found_df$ORF_ID, " "), function(x){x[1]})

# join repeat counts
count_per_ab <- left_join(repeat_counts_center2, rg_ab_found_df, by="record_id") %>% filter(!is.na(Drug.Class))
count_per_ab
```

Boxplot

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE}
box.rep.n.ab <- plot_ly(data = count_per_ab,
                      x = ~strain.x,
                      y = ~n_repeats,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat counts around resistance genes",
         yaxis=list(type="sqrt", title="repeat count"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')
box.rep.n.ab
```

## AR length by AB group

On the same sample of strains

### Table

```{r}
# join repeat_df_center (contains AR lengths) and rg_ab_found (contains AB labels for each gene) by record_id
# prepare "record_id" column in repeat_df_center
repeat_df_center$record_id <- sub("_gene", "", repeat_df_center$record_id)
# join
repeat_df_center_ab_ar <- left_join(rg_ab_found_df, repeat_df_center, by="record_id") %>% filter(!is.na(Drug.Class) & !is.na(spans_center))
repeat_df_center_ab_ar
```

### Boxplot

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE}
box.ar.ab <- plot_ly(data = repeat_df_center_ab_ar,
                      x = ~strain.x,
                      y = ~AR_length,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="AR size variation per AB group",
         yaxis=list(type="sqrt", title="AR length"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')

box.ar.ab
```

## Repeat lengths variation by AB group

```{r, fig.width=16, fig.height = 8, message = FALSE, warning = FALSE}
box.rl.ab <- plot_ly(data = repeat_df_center_ab_ar,
                      x = ~strain.x,
                      y = ~length,
                      color = ~AB.group,
                      type = "box") %>%
  layout(title="Repeat length variation per AB group",
         yaxis=list(type="log", title="AR length"),
         boxmode="group",
         xaxis=list(title=""),
         plot_bgcolor='#e5ecf6')

box.rl.ab

```

## All together

```{r}

```


# Include resistance information

I have some (preliminary) resistacne/susceptebility information for several strains in `resources/resistance_testing.csv`

```{r}
resistance_df <- read.csv("/home/andrei/Data/HeteroR/resources/resistance_testing.csv", na.strings = "")
resistance_df
```

Columns with *SIR* contain susceptibility test results, S - susceptible, R - resistant, I - intermediate.

---

CFX - Cefotaxime, Beta-lactam group

TZP - Pip-Taz

GM - Gentamicin, Aminoglycoside family

AMP - Ampicillin, Penicillin family, Aminopenicillin group

TBM - Tobramycin

TMP - Trimethoprim

NFT - Nitrofurantoin

MCN - Mecillinam

---

Let's leave only them in the data table

```{r}
resistance_df <- select(resistance_df, contains("SIR") | contains("strain"))
resistance_df
```

```{r, message=FALSE, warning=FALSE}
resistance_df_td <- gather(resistance_df, key="AB", value="condition", 1:8)
resistance_df_td$AB <- as.factor(resistance_df_td$AB)
resistance_df_td$condition <- factor(resistance_df_td$condition, ordered=T, levels = c("S", "I", "R"))

resistance_df_td
```

## Resistance heatmap

### Entire table

```{r, fig.width=16, fig.height=4}
htmp_res_all <- ggplot(resistance_df_td, aes(strain, AB)) +
  geom_tile(aes(fill=condition)) +
  theme(axis.text.x = element_text(angle=45, size=4, vjust=0.5))

htmp_res_all
```

### Sample subset

```{r}
res_df_sample <- filter(resistance_df_td, strain %in% strains_sample)
res_df_sample
```

```{r, fig.width=8}
htmp_res_sample <- ggplot(res_df_sample, aes(strain, AB)) +
  geom_tile(aes(fill=condition)) +
  theme(axis.text.x = element_text(angle=45, vjust=0.5))

htmp_res_sample
```

## Repeat number, length, AR length differences between R and S strains

I have genes conferring resistance to Gentamicin (GM) - *Aminoglycoside antibiotic* in the RGI results table.

Also, I have resistant and susceptible strains to GM in my collection - see the heatmaps above

Let's explore differences between R and S

...

Prepare the data

```{r}
ab_res_repeat_df <- inner_join(resistance_df_td, repeat_df_center, by="strain") %>%
  filter(!is.na(condition)) %>%
  filter(condition != "I")

ab_res_repeat_df
```

### Repeat length

```{r, warning = F, message = F, fig.width = 8}
ggbox.rl.ab <- ggplot(ab_res_repeat_df, aes(AB , length)) +
  geom_boxplot(aes(fill=condition), varwidth=T, notch=T) +
  coord_trans(y="log") +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Repeat length")

box.rl.res <- plot_ly(data = ab_res_repeat_df,
                      x = ~AB,
                      y = ~length,
                      color = ~condition,
                      colors = c("#66C2A5", "#FC8D62"),  # taken from Set2
                      type = "box") %>%
                  layout(title="Repeat length in resistant and susceptible strains",
                         yaxis=list(type="log", title="Repeat length"),
                         boxmode="group",
                         xaxis=list(title=""),
                         plot_bgcolor='#e5ecf6')

box.rl.res
```

### AR length

```{r, warning = F, message = F, fig.width = 8}
ggbox.arlen.res <- ggplot(ab_res_repeat_df, aes(AB , AR_length)) +
  geom_boxplot(aes(fill=condition), varwidth=T, notch=T) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("AR length")

box.arlen.res <- plot_ly(data = ab_res_repeat_df,
                      x = ~AB,
                      y = ~AR_length,
                      color = ~condition,
                      colors = c("#66C2A5", "#FC8D62"),  # taken from Set2
                      type = "box") %>%
                  layout(title="Amplifiable region length in resistant and susceptible strains",
                         yaxis=list(title="AR length"),
                         boxmode="group",
                         xaxis=list(title=""),
                         plot_bgcolor='#e5ecf6')

box.arlen.res
```

### Repeat count

Prepare data

```{r, message=FALSE}
ab_res_rep_count <- ab_res_repeat_df %>%
  group_by(AB, condition, strain) %>%
  summarize(n=n()) %>%
  filter(condition != "I")
```

Plot

```{r, warning = F, message = F, fig.width = 8}
ggbox.rc.res <- ggplot(ab_res_rep_count, aes(AB, n)) +
  geom_boxplot(aes(fill = condition)) +
  scale_fill_brewer(palette = "Set2")

box.rc.res <- plot_ly(data = ab_res_rep_count,
                      x = ~AB,
                      y = ~n,
                      color = ~condition,
                      colors = c("#66C2A5", "#FC8D62"),  # taken from Set2
                      type = "box") %>%
                  layout(title="Repeat numbers in resistant and susceptible strains",
                         yaxis=list(title="n"),
                         boxmode="group",
                         xaxis=list(title=""),
                         plot_bgcolor='#e5ecf6')

box.rc.res
```

# Save workspace

```{r}
save.image(f="/home/andrei/Data/HeteroR/notebooks/repeats_summary.RData")
```
