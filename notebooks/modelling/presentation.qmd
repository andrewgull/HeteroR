---
title: "Predicting the unstable heteroresistance from genomic data"
author: "Andrei Guliaev"
format: 
  revealjs:
    logo: figs/UU_logo_color.png
    css: figs/logo.css
    theme: default
    slide-number: true
    show-slide-number: all
editor: source
---

## Definition

::: {.r-fit-text}

>Heteroresistance (HR) is the presence of a heterogeneous population of bacteria with one subpopulation or several subpopulations that exhibit increased levels of antibiotic resistance compared with the main population

-   8-fold above resistance level of main population

-   1.E-07 frequency of resistant population

![](figs/resistance.png){.absolute bottom="250" right="50" width="284" height="200"} 

![](figs/levels_of_resistance.png){.absolute bottom="20" left="10" width="356" height="260"}

![](figs/frequence_of_resistance.png){.absolute bottom="20" right="400" width="218" height="260"}

::: 

## Types of HR

::: {.r-fit-text}

-   **monoclonal**: HR present in pure clones

-   **polyclonal**: mixed infections or rare resistant mutants

![](figs/polyclonal_hr.png){.absolute bottom="50" left="100" width="750" height="300"}

:::

## Types of HR

::: {.r-fit-text}

-   **stable**: if resistance of the subpopulation does not decrease or revert to susceptibility following growth in the absence of antibiotics

-   **unstable**: if the resistance of the subpopulation decreases or reverts to susceptibility following growth in the absence of antibiotics

![](figs/unstable_HR.png){.absolute bottom="20" left="250" width="492" height="400"}

:::

## Mechanisms of ustable HR

::: {.r-fit-text}

- The most common (in G- bacteria): spontaneous amplifications of regions containing resistance genes (RG)

- Amplifications can quickly disappear without presence of AB unlike pint mutations or indels

![](figs/gene_amplification_scheme.png){.absolute bottom="10" left="250" width="540" height="400"}

:::

## Mechanisms of ustable HR

Amplifications are caused by:

::: {.r-fit-text}

- Homologous recombination if duplicated region is surrounded by extensive (>100 bp) direct sequence repeats (DR)

- Insertion sequences (IS)

- Very short DR (~10 bp)

![](figs/amplification_mechanisms.png){.absolute bottom="0" left="250" width="554" height="366"}

:::

##

Our aim is to demonstrate that machine learning can predict unstable HR from genomic data

![](figs/analysis_scheme.png){.absolute bottom="0" left="150" width="741" height="390"}

## Methods

::: columns
::: {.column width="20%"}
![](figs/petri_dish_experimentation_biology_education_petri_dish_icon_143934.png){.absolute width="80" left="50"}
![](figs/sequencing-icon.png){.absolute width="75" left="64" bottom="410"}
![](figs/snakemake_logo.png){.absolute width="80" left="60" bottom="310"}

![](figs/laptop.png){.absolute width="80" left="60" bottom="210"}

![](figs/robot.png){.absolute width="80" left="60" bottom="100"}
:::

::: {.column width="80%"}
500 *E.coli* strains tested for HR to Piperacillin-Tazobactam

WGS using both Nanopore and Illumina

A computational pipeline for assembling genomes, annotating RG, DR and IS

Creating predictors (avg. repeat length, RG count, IS count etc.)

Creating a model that can distinguish HR and nonHR strains (supervised ML)
:::
:::

## Predictors (a.k.a. Features) {.smaller}

::: {.incremental}

- RG count (especially beta-lactamases)
- RG types
- mean length of DR
- maximum length of DR
- mean number of IS
- mean length of IS
- location on plasmids or chromosomes
- distance to *ori*C
- length of amplifiable region (AR)
- plasmids count
- *coverage*
- *the longest Nanopore read length*
:::

## HR testing

::: {.incremental}

- HR (groups I + II): 81 strains

- nonHR: 393 strains

- pure resistance: 13 strains

:::

## Genome completeness

```{r}
library(tidyverse)

### READ DATA
data_strain <- read_csv("data/features_strain.csv", na = c("NA", "-Inf"), show_col_types = F)

### TMP SOLUTION
# rsync ~/Data/HeteroR/results/tables/plasmid_copy_number.csv ./data
pl_copy_number <- read_delim("data/plasmid_copy_number.csv", show_col_types = FALSE, delim = " ")
data_strain <- data_strain %>% left_join(pl_copy_number, by="strain") %>% 
  rename(plasmid.copy.number = tot_plasmids)

## READ TESTING
hr_testing12 <- read_csv("data/heteroresistance_testing.csv", col_select = c(strain, Gr12), show_col_types = F) %>% 
  filter(!is.na(strain)) %>% 
  rename("resistance" = Gr12 )

data_strain <- data_strain %>% 
  left_join(hr_testing12, by = "strain")

data_strain <- data_strain %>% 
  #mutate(n.beta.lac.3 = factor(ifelse(n.beta.lac > 3, "yes", "no"))) %>% 
  mutate(n.beta.lac.4 = factor(ifelse(n.beta.lac > 4, "yes", "no"))) %>% 
  relocate(n.beta.lac.4, .before = "n.plasmids") %>% 
  filter(resistance != "R") %>% 
  mutate(resistance = factor(resistance, levels = c("HR", "nonHR")),
         chrom.status = factor(chrom.status))

data_strain$N50 <- NULL
#data_strain$NA. <- NULL
data_strain[is.na(data_strain)] <- 0

data_strain <-
  data_strain %>% rename(SLF = sulfonamide.resistant.sul, 
                         TMP.DFR = trimethoprim.resistant.dihydrofolate.reductase.dfr,
                         MPH = macrolide.phosphotransferase.MPH,
                         CTX.M = CTX.M.beta.lactamase,
                         ampC = ampC.type.beta.lactamase,
                         CAT = chloramphenicol.acetyltransferase.CAT,
                         OXA = OXA.beta.lactamase,
                         AAC.6 = AAC6.Ib.cr,
                         SAT = streptothricin.acetyltransferase.SAT,
                         SHV = SHV.beta.lactamase,
                         TTC.rpp = tetracycline.resistant.ribosomal.protection.protein,
                         FTT = fosfomycin.thiol.transferase,
                         QNR = quinolone.resistance.protein.qnr,
                         DHA = DHA.beta.lactamase,
                         TEM = TEM.beta.lactamase)

## PLOT
data_strain %>% 
  group_by(resistance, chrom.status) %>% 
  count() %>% 
  ggplot(aes(chrom.status, n)) +
  geom_col(position = "dodge", aes(fill=resistance), alpha=0.8) + 
  scale_fill_brewer(palette = "Set1") +
  facet_grid(cols = vars(resistance)) +
  ylab("N strains") +
  xlab("") +
  guides(fill = "none")
```

## Coverage

```{r}
data_strain %>% 
    ggplot(aes(resistance, coverage)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(
    aes(fill = resistance),
    alpha = 0.2,
    notch = F,
    varwidth = T
  ) +
  geom_jitter(alpha = 0.2,
              width = 0.15,
              height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ggtitle("") +
  ylab("n") +
  xlab("") +
  guides(fill = "none")
```

Sequencing coverage may influence prediction!

## Read length vs Coverage

```{r}
data_strain %>% 
  ggplot(aes(read.max.len, coverage)) +
  geom_point(aes(color = resistance), alpha=0.6) +
  scale_color_brewer(palette = "Set1") +
  #scale_x_continuous(trans = "log10")+
  #geom_abline(intercept = 50, slope = 20) +
  ggtitle("") +
  guides(fill = "none") +
  xlab("maximum read length, bp") +
  ylab("coverage, x")
```

## Beta-lactamase gene count

```{r}
ggplot(data_strain, aes(n.beta.lac)) +
  geom_bar(aes(fill = resistance), position = "fill") +
  scale_fill_brewer(palette="Set1") +
  xlab("N") +
  ylab("Proportion of strains") +
  theme(legend.title = element_blank()) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6))
```

## If N beta-lactamases > 3

```{r}
data_strain %>% 
  ggplot(aes(n.beta.lac.4)) +
  geom_bar(aes(fill = resistance), position = "fill") +
  scale_fill_brewer(palette="Set1") +
  xlab("N > 3") +
  ylab("proportion of strains") +
  #scale_x_discrete(breaks = c(0, 1), labels = c("no" = "No", "yes" = "Yes")) +
  theme(legend.title=element_blank())
```

## Beta-lactamases on plasmids

```{r}
ggplot(data_strain, aes(n.beta.lac.plasmid)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  scale_x_continuous(breaks = c(0,1,2,3,4,5)) +
  xlab("N") +
  ylab("Proportion of strains")
```

## ampC beta-lac

This plot doesn't make much sense to me...

```{r}
bl_type_count <- data_strain %>% 
  select(resistance, n.beta.lac, ampC) %>% 
  mutate(non.ampC = n.beta.lac - ampC) %>% 
  select(-n.beta.lac) %>% 
  gather(key = "gene", value = "n", 2:3) %>% 
  group_by(resistance, gene) %>% 
  summarize(sum=sum(n))


ggplot(bl_type_count, aes(gene, sum))+
  geom_col(aes(fill=resistance), position = "dodge", alpha = 1) + 
  # scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.7) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("") +
  ylab("proportion")+
  scale_x_discrete(labels = c("ampC", "non-ampC"))
  
```

## TEM beta-lactamase

```{r}
ggplot(data_strain, aes(TEM)) +
  geom_bar(aes(fill = resistance), position = "fill", alpha = 1) +
  scale_fill_brewer(palette = "Set1", name = "") +
  xlab("N") +
  ylab("proportion")
```

## RG counts heatmap

```{r, fig.width=8, fig.height=4}
amr_types_strain <- read_csv("data/amr_types_strain.csv", show_col_types = FALSE)

amr_types_strain_td <- gather(amr_types_strain, key = "AMR.type", value = "N", 2:ncol(amr_types_strain))

library(plotly)

vals <- scales::rescale(c(0:max(amr_types_strain_td$N)))
o <- order(vals, decreasing = FALSE)
cols <- scales::col_numeric("Blues", domain = NULL)(vals)
colz <- setNames(data.frame(vals[o], cols[o]), NULL)
fig <- plot_ly(z = amr_types_strain_td$N, 
               x = amr_types_strain_td$strain, 
               y = amr_types_strain_td$AMR.type, 
               type = "heatmap", 
               colorscale = colz)
fig
```

## Plasmid count

not copy number!

```{r}
data_strain %>%
  ggplot(aes(resistance, n.plasmids)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(
    aes(fill = resistance),
    alpha = 0.2,
    notch = F,
    varwidth = T
  ) +
  geom_jitter(alpha = 0.2,
              width = 0.15,
              height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  ggtitle("") +
  ylab("n") +
  xlab("") +
  guides(fill = "none")
```

## Plasmid copy number

Inferred from relative coverage

```{r}
data_strain %>%
  #filter(plasmid.copy.number > 0) %>% 
  ggplot(aes(resistance, plasmid.copy.number)) +
  geom_violin(aes(fill = resistance), alpha = 0.7) +
  geom_boxplot(
    aes(fill = resistance),
    alpha = 0.2,
    notch = F,
    varwidth = T
  ) +
  geom_jitter(alpha = 0.2,
              width = 0.15,
              height = 0.1) +
  scale_fill_brewer(palette = "Set1") +
  #scale_y_continuous(trans = "sqrt") +
  ggtitle("") +
  ylab("cn") +
  xlab("") +
  guides(fill = "none")

```


## Correlatied features

```{r, out.height='200%'}
#| label: figure
# without resistance
cor_matrix <- data_strain %>%
  select(-c(
    strain,
    resistance,
    #n.beta.lac.3,
    n.beta.lac.4,
    chrom.status,
    contains(c("APH", "ANT", "PH", "CAT", "AAC", "SAT", "DHA", "QNR"), ignore.case = FALSE)
  )) %>%
  cor(use = "pairwise.complete.obs", method = "spearman")

corrplot::corrplot(cor_matrix, type = "upper", tl.col = "black", tl.cex = 0.5 )
```



